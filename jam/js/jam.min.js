(function(a){"use strict";var b,c,d={"RESPONSE":1,"NOT_LOGGED":2,"UNDER_MAINTAINANCE":3,"NO_PROJECT":4,"TEXT":1,"INTEGER":2,"FLOAT":3,"CURRENCY":4,"DATE":5,"DATETIME":6,"BOOLEAN":7,"BLOB":8,"ITEM_FIELD":1,"FILTER_FIELD":2,"PARAM_FIELD":3,"FILTER_EQ":1,"FILTER_NE":2,"FILTER_LT":3,"FILTER_LE":4,"FILTER_GT":5,"FILTER_GE":6,"FILTER_IN":7,"FILTER_NOT_IN":8,"FILTER_RANGE":9,"FILTER_ISNULL":10,"FILTER_EXACT":11,"FILTER_CONTAINS":12,"FILTER_STARTWITH":13,"FILTER_ENDWITH":14,"FILTER_CONTAINS_ALL":15,"ALIGN_LEFT":1,"ALIGN_CENTER":2,"ALIGN_RIGHT":3,"STATE_INACTIVE":0,"STATE_BROWSE":1,"STATE_INSERT":2,"STATE_EDIT":3,"STATE_DELETE":4,"RECORD_UNCHANGED":null,"RECORD_INSERTED":1,"RECORD_MODIFIED":2,"RECORD_DELETED":3,"RECORD_DETAILS_MODIFIED":4,"REC_STATUS":0,"REC_CONTROLS_INFO":1,"REC_CHANGE_ID":2,"UPDATE_OPEN":0,"UPDATE_DELETE":1,"UPDATE_CANCEL":2,"UPDATE_APPEND":3,"UPDATE_INSERT":4,"UPDATE_SCROLLED":5,"UPDATE_CONTROLS":6,"UPDATE_REFRESH":7,"UPDATE_CLOSE":8},e=['','left','center','right'],f=['eq','ne','lt','le','gt','ge','in','not_in','range','isnull','exact','contains','startwith','endwith','contains_all'];function g(a,b,c,d,e,f,g){if(e===undefined)e=true;this.owner=a;this.item_name=c||'';this.item_caption=d||'';this.visible=e;this.ID=b||undefined;this.item_type_id=f;this.item_type='';if(f)this.item_type=this.types[f-1];if(g)this.js_filename='js/'+g;this.modal_options={width:560,left:undefined,top:undefined,close_focusout:false,transition:false,title:'',fields:[],close_button:true,close_caption:true,close_on_escape:true,show_history:false,print:false};this.items=[];if(a){if(!a.find(c))a.items.push(this);if(!(c in a))a[c]=this;this.task=a.task;}}g.prototype={constructor:g,types:["root","users","roles","tasks",'task',"items","items","tables","reports","item","item","table","report","detail"],get_master_field:function(a,b){var c=0,d=a.length;for(;c<d;c++)if(a[c].ID==b)return a[c];},each_item:function(a){var b=0,c=this.items.length,d;for(;b<c;b++){d=a.call(this.items[b],this.items[b],b);if(d===false)break;}},all:function(a){var b=0,c=this.items.length;a.call(this,this);for(;b<c;b++)this.items[b].all(a);},find:function(a){var b=0,c=this.items.length;for(;b<c;b++)if(this.items[b].item_name===a)return this.items[b];},item_by_ID:function(a){var b;if(this.ID===a)return this;var c=0,d=this.items.length;for(;c<d;c++){b=this.items[c].item_by_ID(a);if(b)return b;}},addChild:function(a,b,c,d,e,f){var g;if(this.getChildClass){g=this.getChildClass();if(g)return new g(this,a,b,c,d,e,f);}},send_request:function(a,b,c){return this.task.process_request(a,this,b,c);},init:function(a){var b=0,c=a.items,d,e=c.length,f;for(;b<e;b++){f=c[b][1];d=this.addChild(f.id,f.name,f.caption,f.visible,f.type,f.js_filename);d._default_order=f.default_order;d._primary_key=f.primary_key;d._deleted_flag=f.deleted_flag;d._master_id=f.master_id;d._master_rec_id=f.master_rec_id;d.keep_history=f.keep_history;if(d.initAttr)d.initAttr(f);d.init(f);}},bind_items:function(){var a=0,b=this.items.length;if(this.bind_item)this.bind_item();for(;a<b;a++)this.items[a].bind_items();},script_loaded:function(){if(this.js_filename)return this.task._script_cache[this.js_filename];else return true;},load_script:function(a,b,c){var d=this,e,f,g;if(a&&!this.task._script_cache[a]){g=document.createElement('script');f=document.getElementsByTagName('script')[0];e=a;g.src=e;g.type="text/javascript";g.async=true;f.parentNode.insertBefore(g,f);g.onload=function(){d.task._script_cache[a]=true;if(c)c.call(d,d);if(b)b.call(d,d);};}else if(b)b.call(d,d);},load_module:function(a){this.load_modules([this],a);},load_modules:function(a,b){var c=this,d=0,e=a.length,f,g=[],h=0,i=false,j=function(a){a.load_script(a.js_filename,function(){if(--h===0)if(b&&!i){i=true;b.call(c,c);}},function(){a.bind_handlers();});};for(;d<e;d++){f=a[d];if(!f.script_loaded())g.push(f);if(f.details&&f.each_detail)f.each_detail(function(a){if(!a.script_loaded())g.push(a);});}e=g.length;h=e;if(e)for(d=0;d<e;d++)j.call(g[d],g[d]);else if(b)b.call(this,this);},bind_handlers:function(){var a=task.events['events'+this.ID];this._events=[];for(var b in a)if(a.hasOwnProperty(b)){this[b]=a[b];this._events.push([b,a[b]]);}},bind_events:function(){var a=0,b=this.items.length;this.bind_handlers();for(;a<b;a++)this.items[a].bind_events();},can_view:function(){return this.task.has_privilege(this,'can_view');},_search_template:function(a,b){var c,d="."+a;if(b)d="."+a+"-"+b;c=this.task.templates.find(d);if(c.length)return c;},find_template:function(a,b){var c,d,e,f=this;if(b.template_class)d=this._search_template(b.template_class);if(!d){if(f.item_type==="detail"){d=this._search_template(f.owner.item_name+"-"+f.item_name,a);if(!d)d=this._search_template(f.owner.owner.item_name+"-details",a);if(!d)d=this._search_template("default-details",a);if(!d)f=f.owner;}if(!d)while(true){e=f.item_name;d=this._search_template(f.item_name,a);if(d)break;f=f.owner;if(f===f.task)break;}}if(!d)d=this._search_template('default',a);if(d)c=d.clone();else this.warning(this.item_caption+': '+a+' form template not found.');return c;},server:function(b,c,d){var e,f,g;if(arguments.length==2&&typeof arguments[1]==="function"){d=arguments[1];c=[];}if(!c)c=[];else if(!a.isArray(c))c=[c];if(d){this.send_request('server_function',[b,c],function(a){e=a[0];f=a[1];d.call(this,e,f);if(f)throw f;});}else{g=this.send_request('server_function',[b,c]);e=g[0];f=g[1];if(f)throw f;else return e;}},makeFormModal:function(b,c,d){var e,f,g,h,i,j={title:this.item_caption,close_caption:true,close_button:true,print:false};function k(a){if(h){a.preventDefault();g.css('cursor','auto');f.css('margin-left',parseInt(f.css('margin-left'),10)+a.screenX-h);f.css('margin-top',parseInt(f.css('margin-top'),10)+a.screenY-i);h=a.screenX;i=a.screenY;}}function l(a){h=undefined;i=undefined;e.off("mousemove.modalform");e.off("mouseup.modalform");}c=a.extend({},j,c);if(!c.title)c.title='&nbsp';f=a('<div class="modal hide normal-modal-border" tabindex="-1" data-backdrop="static">'+'<div class="modal-header">'+'</div>'+'</div>');e=a(document);this._set_form_options(f,c);g=f.find('.modal-title');g.on("mousedown",function(a){h=a.screenX;i=a.screenY;e.on("mousemove.modalform",k);e.on("mouseup.modalform",l);});g.on("mousemove",function(b){a(this).css('cursor','move');});f.append(b);return f;},_set_form_options:function(a,b,d){var e=this,f=a.find('.modal-header'),g=f.find('.modal-title'),h='',i='',j='',k='',l='';if(b.close_button){if(c&&b.close_caption)h='&nbsp;'+c.close+' - [Esc]</small>';i='<button type="button" id="close-btn" class="close" tabindex="-1" aria-hidden="true" style="padding: 0px 10px;">'+h+' ×</button>';}if(c&&b.print)j='&nbsp;'+c.print+' - [Ctrl-P]</small>',k='<button type="button" id="print-btn" class="close" tabindex="-1" aria-hidden="true" style="padding: 0px 10px;">'+j+'</button>';if(b.show_history&&this.keep_history)l='<i id="history-btn" class="icon-film" style="float: right; margin: 5px;"></i>';if(!g.length)g=('<h4 class="modal-title">'+b.title+'</h4>');else{g.detach();g.html(b.title);}f.empty();f.append(i+l+k);f.append(g);f.find("#close-btn").css('cursor','default').click(function(a){if(d)e.close_form(d);});f.find('#print-btn').css('cursor','default').click(function(b){e.print_message(a.find(".modal-body").clone());});f.find('#history-btn').css('cursor','default').click(function(a){e.show_history();});},_close_modeless_form:function(a){var b=this;if(this[a])this.close_form(a);if(this[a]){this[a].bind('destroyed',function(){b._close_modeless_form(a);});throw this.item_name+" - can't close form";}},create_form:function(b,c){var d=this,e=b+'_form',f=e+'.'+this.item_name,g=this[b+'_options'];if(this[e]&&c.container)this._close_modeless_form(e);this[e]=a("<div></div>").append(this.find_template(b,g));if(!c.container)this[e]=this.makeFormModal(this[e],g);if(this[e]){this[e]._options=c;this[e].tabindex=1;if(c.container){c.container.empty();a(window).on("keyup."+f,function(a){a.stopPropagation();if(c.onKeyUp)c.onKeyUp.call(d,a);});a(window).on("keydown."+f,function(a){a.stopPropagation();if(c.onKeyDown)c.onKeyDown.call(d,a);});c.container.append(this[e]);this[e].bind('destroyed',function(){d._close_modeless_form(e);});if(c.beforeShow)c.beforeShow.call(this);if(c.onShown)c.onShown.call(this);}else if(this[e].hasClass("modal")){this[e].on("show",function(a){a.stopPropagation();if(c.beforeShow)c.beforeShow.call(d,a);if(d[e].title)g.title=d[e].title;if(d[e].modal_width)g.width=d[e].modal_width;d._set_form_options(d[e],g,e);});this[e].on("shown",function(a){a.stopPropagation();if(c.onShown)c.onShown.call(d,a);});this[e].on("hide",function(a){var b=true;a.stopPropagation();if(c.onHide)b=c.onHide.call(d,a);if(b===false){a.preventDefault();d[e].data('_closing',false);}});this[e].on("hidden",function(a){a.stopPropagation();if(c.onHidden)c.onHidden.call(d,a);d[e].remove();d[e]=undefined;});this[e].on("keydown."+f,function(a){if(a.which!==116)a.stopPropagation();if(c.onKeyDown)c.onKeyDown.call(d,a);});this[e].on("keyup."+f,function(a){a.stopPropagation();if(c.onKeyUp)c.onKeyUp.call(d,a);});this[e].modal({item:this,form_name:e,item_options:g});}}},close_form:function(b){var c=this,d=this[b],e,f=b+'.'+this.item_name;if(d){d.data('_closing',true);if(d.hasClass('modal'))setTimeout(function(){d.modal('hide');},100);else{if(d._options&&d._options.onHide)e=d._options.onHide.call(c);if(e!==false){a(window).off("keydown."+f);a(window).off("keyup."+f);this[b]=undefined;d.remove();}}}},print_message:function(b){var c=window.frames.dummy,d=a("link[rel='stylesheet']"),e='<head>';d.each(function(a,b){e+='<link href="'+b.href+'" rel="stylesheet">';});e+='</head>';c.document.write(e+'<body onload="window.print()">'+b.html()+'</body>');a("link[rel='stylesheet']").clone().appendTo(a("dummy").contents().find("head"));c.document.close();},message:function(b,c){var d=1,e=this,f={title:'',width:400,height:undefined,margin:undefined,buttons:undefined,default_button:undefined,print:false,text_center:false,button_min_width:100,center_buttons:false,close_button:true,close_on_escape:true},g,h,i='',j,k,l=a('<button type="button" class="btn">OK</button>'),m;if(b instanceof jQuery)b=b.clone();c=a.extend({},f,c);g=c.buttons;i='<div class="modal-body"></div>';if(!this.is_empty_obj(g))i+='<div class="modal-footer"></div>';j=this.makeFormModal(a(i),c);k=j.find('.modal-body');if(c.margin)k.css('margin',c.margin);k.html(b);if(!c.title)j.find('.modal-header').remove();if(c.text_center)k.html(b).addClass("text-center");if(c.center_buttons)j.find(".modal-footer").css("text-align","center");j.find("#close-btn").click(function(a){j.modal('hide');});for(h in g)if(g.hasOwnProperty(h)){j.find(".modal-footer").append(l.clone().data('key',h).attr("tabindex",d).css("min-width",c.button_min_width).html(h).click(function(b){var c=a(this).data('key');setTimeout(function(){try{if(g[c])g[c].call(e);}catch(a){}j.modal('hide');},0);}));d++;}j.on("shown",function(a){a.stopPropagation();});j.on("hide",function(a){a.stopPropagation();});j.on("hidden",function(a){a.stopPropagation();});j.on("keyup keydown",function(a){var b=(a.keyCode?a.keyCode:a.which);a.stopPropagation();if(b===80&&a.ctrlKey){a.preventDefault();e.print_message(j.find(".modal-body").clone());}});j.modal({width:c.width,height:c.height,keyboard:c.close_on_escape});return j;},question:function(b,d,e,f){var g={},h={buttons:g,margin:"20px 20px",text_center:true,center_buttons:true};f=a.extend({},h,f);g[c.yes]=d;g[c.no]=e;return this.message(b,f);},warning:function(b,c,d){var e={"OK":c},f={buttons:e,margin:"20px 20px",text_center:true,center_buttons:true};d=a.extend({},f,d);return this.message(b,d);},show_message:function(a,b){return this.message(a,b);},hide_message:function(a){a.modal('hide');},yes_no_cancel:function(a,b,d,e){var f={};f[c.yes]=b;f[c.no]=d;f[c.cancel]=e;return this.message(a,{buttons:f,margin:"20px 20px",text_center:true,width:500,center_buttons:true});},show_history:function(){var b=this,c=this.task.history_item.copy();c.set_where({item_id:this.ID,item_rec_id:this.field_by_name(this._primary_key).value});c.set_order_by(['-date']);c.open(function(){var e='',f=a('<div class="accordion" id="accordion1">'),g,h,i={},j,k,l,m,n,o;if(b.master){h=b.master.copy({handlers:false}),g=h.item_by_ID(b.ID);h.open({open_empty:true});h.append();}else g=b.copy({handlers:false,details:false});g.open({open_empty:true});g.append();c.each(function(c){var e=a('<div class="accordion-group history-group">'+'<div class="accordion-heading history-heading">'+'<a class="history-toggle accordion-toggle" data-toggle="collapse" data-parent="#accordion1" href="#collapse'+c.rec_no+'">'+'</a>'+'</div>'+'<div id="collapse'+c.rec_no+'" class="accordion-body collapse">'+'<div class="accordion-inner history-inner">'+'</div>'+'</div>'+'</div>'),h,j='',k='',l,m,n,o,p=JSON.parse(c.changes.value),q,r;if(c.operation.value===d.RECORD_DELETED)k='<p>Record deleted</p>';else if(c.operation.value===d.RECORD_DETAILS_MODIFIED)k='<p>Details modified</p>';else if(p){q=p[0];r=p[1];if(q)for(h=0;h<q.length;h++){n=g.field_by_ID(q[h][0]);if(n&&!n.system_field()){o=n.field_caption;if(n.lookup_item){if(!i[n.lookup_item.ID])i[n.lookup_item.ID]=[];n.set_data(q[h][1]);l=n.value;n.set_data(q[h][2]);m=n.value;if(l){i[n.lookup_item.ID].push([n.lookup_field,l]);l='<span class="'+n.lookup_field+'_'+l+'">value is loading</span>';}if(m){i[n.lookup_item.ID].push([n.lookup_field,m]);m='<span class="'+n.lookup_field+'_'+m+'">value is loading</span>';}}else{n.set_data(q[h][1]);l=n.display_text;n.set_data(q[h][2]);m=n.display_text;}if(c.operation.value===d.RECORD_INSERTED)k+='<p>'+b.task.language.field+' <b>'+o+'</b>: '+b.task.language.new_value+': <b>'+m+'</b></p>';else if(c.operation.value===d.RECORD_MODIFIED)k+='<p>'+b.task.language.field+' <b>'+o+'</b>: '+b.task.language.old_value+': <b>'+l+'</b> '+b.task.language.new_value+': <b>'+m+'</b></p>';}}}if(c.user.value)j=b.task.language.by_user+' '+c.user.value;e.find('.accordion-toggle').html(c.date.display_text+': '+c.operation.display_text+' '+j);e.find('.accordion-inner').html(k);if(c.rec_no===0)e.find('.accordion-body').addClass('in');f.append(e);});if(c.record_count())e=f;b.task.message(e,{width:700,height:600,title:b.item_caption+': history',footer:false,print:true});for(var p in i)if(i.hasOwnProperty(p)){o=b.task.item_by_ID(parseInt(p,10));if(o){o=o.copy({handlers:false});j={};k={};k[o._primary_key]=true;for(var q=0;q<i[p].length;q++){k[i[p][q][0]]=true;j[i[p][q][1]]=true;}l=[];for(var r in j)if(j.hasOwnProperty(r))l.push(parseInt(r,10));m=[];for(var s in k)if(k.hasOwnProperty(s))m.push(s);n={};n[o._primary_key+'__in']=l;o.open({where:n,fields:m},function(){o.each(function(a){a.each_field(function(b){if(!b.system_field())f.find("."+b.field_name+'_'+a._primary_key_field.value).text(b.value);});});});}}});},is_empty_obj:function(a){for(var b in a)if(a.hasOwnProperty(b))return false;return true;},emptyFunc:function(){},abort:function(a){a=a?' - '+a:'';throw 'execution aborted: '+this.item_name+a;},log_message:function(a){if(this.task.settings.DEBUGGING){a=a?' message: '+a:'';console.log(this.item_name+a);}}};h.prototype=new g();function h(a,b){var c=this;g.call(this,undefined,0,a,b,true);this.task=this;this.user_info={};this._script_cache={};this.gridId=0;}a.extend(h.prototype,{constructor:h,consts:d,getChildClass:function(){return i;},process_request:function(b,e,f,g){var h=this,i=new Date().getTime(),j=false,k={},l="application/json;charset=utf-8",m;if(g)j=true;if(this.ajaxStatusCode)k=this.ajaxStatusCode;a.ajax({url:"api",type:"POST",contentType:l,async:j,cache:false,data:JSON.stringify([b,this.user_id,this.ID,e.ID,f,i]),statusCode:k,success:function(b){var f;if(b.error)console.log(b);else if(b.result.status===d.NO_PROJECT){a('body').empty();e.warning('Creating a project is not finished yet. Run the Administrator to finish.');return;}else if(b.result.status===d.UNDER_MAINTAINANCE){if(!h.task._under_maintainance){h.task._under_maintainance=true;if(c)f=c.website_maintenance;else f='Web site currently under maintenance.';e.warning(f,function(){h.task._under_maintainance=undefined;});}return;}else if(b.result.status===d.NOT_LOGGED){if(!h.logged_in){if(h.user_id){h.user_id=null;h.erase_cookie(location.port+':user_id');}h.login();}else location.reload();return;}else if(h.ID>0&&b.result.version&&h.version&&b.result.version!==h.version){if(!h.task._version_changed){h.task._version_changed=true;h.message('<h4>'+c.version_changed+'</h4>',{margin:'50px 0px',width:500,text_center:true});}return;}if(g)g.call(e,b.result.data);else m=b.result.data;},error:function(a,b,d){if(a.responseText&&h.ID!==0){document.open();document.write(a.responseText);document.close();}else if(c)if(!h.task._server_request_error){h.task._server_request_error=true;h.warning(c.server_request_error,function(){h.task._server_request_error=undefined;});}},fail:function(a,b,c){console.log('ajax fail: ',a,b,c);}});if(m!==undefined)return m;},_byteLength:function(a){var b=a.length;for(var c=a.length-1;c>=0;c--){var d=a.charCodeAt(c);if(d>0x7f&&d<=0x7ff)b++;else if(d>0x7ff&&d<=0xffff)b+=2;if(d>=0xDC00&&d<=0xDFFF)c--;}return b;},do_upload:function(a,b,c){var d=this,e,f,g=[],h,i='',j=[],k=';',l=new XMLHttpRequest(),m=this.ID+';'+this.user_id;i+=m.length+';'+m+k;i+=b.length+k;i+=this._byteLength(a)+k;for(e=0;e<b.length;e++){f=b[e][0];h=b[e][1];i+=this._byteLength(f.name)+k;i+=h.byteLength+k;g.push(f.name);}j.push(i);j.push(a);for(e=0;e<b.length;e++){f=b[e][0];h=b[e][1];j.push(f.name);j.push(h);}l.open('POST','upload',true);if(c.callback)l.onload=function(a){if(c.multiple)c.callback.call(d,d,g);else c.callback.call(d,d,g[0]);};if(c.on_progress)l.upload.onprogress=function(a){c.on_progress.call(d,d,a);};var n=new Blob(j,{type:'application/octet-stream'});l.send(n);},upload:function(b,c){var d=this,e={callback:undefined,on_progress:undefined,extension:undefined,multiple:false},f=a('<input type="file" style="position: absolute; top: -100px"/>');c=a.extend({},e,c);if(c.multiple)f.attr('multiple','multiple');a('body').append(f);f.on('change',function(a){var e=a.target.files,g,h,i,j,k,l=[],m,n=[];for(g=0,j;j=e[g];g++){i='';if(c.extension){h=j.name.split('.');if(h.length)i=h[h.length-1];if(i!==c.extension)continue;}n.push(j);}for(g=0;g<n.length;g++){k=n[g];m=new FileReader();m.onload=(function(a){return function(e){l.push([a,e.target.result]);if(l.length===n.length)d.do_upload(b,l,c);};})(k);m.readAsArrayBuffer(k);}f.remove();});f.click();},load:function(){var e=this,f;if(!this.user_id){this.user_id=this.read_cookie(location.port+':user_id');if(this.user_id==="null")this.user_id=null;}this.send_request('init_client',null,function(f){var g=f[0],h=f[1],i;if(h){e.warning(h);return;}e.logged_in=true;b=g.settings;c=g.language;e.settings=g.settings;e.language=g.language;e.user_info=g.user_info;e.user_privileges=g.privileges;e.consts=d;e.safe_mode=e.settings.SAFE_MODE;e.version=e.settings.VERSION;e.ID=g.task.id;e.item_name=g.task.name;e.item_caption=g.task.caption;e.visible=g.task.visible;e.lookup_lists=g.task.lookup_lists;e.history_item=g.task.history_item;e.item_type="";if(g.task.type)e.item_type=e.types[g.task.type-1];if(g.task.js_filename)e.js_filename='js/'+g.task.js_filename;e.task=e;e.templates=a("<div></div>");i=a(".templates");e.templates=i.clone();i.remove();e.init(g.task);e.bind_items();if(e.ID===0){e.js_filename='jam/js/admin.js';e.settings.DYNAMIC_JS=false;}if(e.static_js_modules){e.bind_events();if(e.on_page_loaded)e.on_page_loaded.call(e,e);}else e.init_modules();if(e.history_item)e._set_history_item(e.item_by_ID(e.history_item));});},_set_history_item:function(a){var b=this;this.history_item=a;if(this.history_item){this.history_item.read_only=true;a.view_options.fields=['item_id','item_rec_id','date','operation','user'];if(!a.on_field_get_text)a.on_field_get_text=function(a){var c,e;if(a.field_name==='operation'){if(a.value===d.RECORD_INSERTED)return b.language.created;else if(a.value===d.RECORD_MODIFIED||a.value===d.RECORD_DETAILS_MODIFIED)return b.language.modified;else if(a.value===d.RECORD_DELETED)return b.language.deleted;}else if(a.field_name==='item_id'){e=b.item_by_ID(a.value);if(e)return e.item_caption;}};}},init_modules:function(){var a=this,b=0,c=false,d=function(a){if(a.js_filename)b++;},e=function(d){if(d.js_filename)d.load_script(d.js_filename,function(){if(--b===0){a.bind_events();if(a.on_page_loaded&&!c){c=true;a.on_page_loaded.call(a,a);}}});};if(this.settings.DYNAMIC_JS){b=1;e(this);}else{this.all(d);this.all(e);}},login:function(){var b=this,c,d;if(this.templates)d=this.templates.find("#login-form").clone();else d=a("#login-form").clone();d=this.makeFormModal(d,{title:d.data('caption'),transition:false});d.find("#login-btn").click(function(a){var c=d.find("#inputLoging").val(),e=d.find("#inputPassword").val(),f=hex_md5(e);b.user_id=b.send_request('login',[c,f])[0];b.create_cookie(location.port+':user_id',b.user_id,0.5);if(b.user_id){if(d)d.modal('hide');location.reload();}});d.find("#close-btn").click(function(a){d.modal('hide');});d.on("shown",function(a){d.find("#inputLoging").focus();a.stopPropagation();});d.find('input').keydown(function(b){var c=a(this),e=(b.keyCode?b.keyCode:b.which);if(e===40)if(c.attr('id')==='inputLoging')d.find('#inputPassword').focus();else d.find('#login-btn').focus();});d.modal({width:500});},logout:function(){this.send_request('logout',this.user_id);this.user_id=null;this.erase_cookie(location.port+':user_id');location.reload();},has_privilege:function(a,b){var c;if(a.task.ID===0)return true;if(!this.user_privileges||a.master)return true;else{if(!this.user_privileges)return false;try{c=this.user_privileges[a.ID];}catch(d){c=null;}if(c)return c[b];else return false;}},create_cookie:function(a,b,c){var d;if(c){var e=new Date();e.setTime(e.getTime()+(c*24*60*60*1000));d="; expires="+e.toGMTString();}else d="";document.cookie=escape(a)+"="+escape(b)+d+"; path=/";},read_cookie:function(a){var b=escape(a)+"=";var c=document.cookie.split(';');for(var d=0;d<c.length;d++){var e=c[d];while(e.charAt(0)===' ')e=e.substring(1,e.length);if(e.indexOf(b)===0)return unescape(e.substring(b.length,e.length));}return null;},erase_cookie:function(a){this.create_cookie(a,"",-1);},show_context_menu:function(b,c){if(b.length){c.preventDefault();this.$context_menu=b;this.$context_menu_parent=b.parent();b.detach();a('body').prepend(b);b.show();b.find('ul').css({top:c.pageY+"px",left:c.pageX+"px"}).show();}}});i.prototype=new g();i.prototype.constructor=i;function i(a,b,c,d,e,f,h){g.call(this,a,b,c,d,e,f,h);}i.prototype.getChildClass=function(){if(this.item_type==="reports")return l;else return k;};function j(a){this.item=a;this._change_id=0;this.records=[];this.logs={};this.fields=[];this.expanded=true;}j.prototype={constructor:j,get_change_id:function(){this._change_id+=1;return this._change_id+'';},is_empty_obj:function(a){for(var b in a)if(a.hasOwnProperty(b))return false;return true;},log_changes:function(){if(this.item.master)return this.item.master.change_log.log_changes();else return this.item.log_changes;},find_record_log:function(){var a,b,c,d,e,f,g=[],h;if(this.item.master){b=this.item.master.change_log.find_record_log();if(b){c=b.details;d=c[this.item.ID];if(this.is_empty_obj(d)){f=this.item.fields.length;for(e=0;e<f;e++)g.push(this.item.fields[e].field_name);d={logs:{},records:this.item._dataset,fields:g,expanded:this.item.expanded};c[this.item.ID]=d;}this.logs=d.logs;this.records=d.records;this.fields=d.fields;this.expanded=d.expanded;}}if(this.item.record_count()){h=this.item._get_rec_change_id();if(!h){h=this.get_change_id();this.item._set_rec_change_id(h);}a=this.logs[h];if(this.is_empty_obj(a)){a={old_record:null,record:this.cur_record(),details:{}};this.logs[h]=a;}}return a;},get_detail_log:function(a){var b,c,d;c=this.find_record_log();d=c.details;if(!this.is_empty_obj(d))b=d[a];if(b===undefined&&this._is_delta)b={records:[],fields:[],expanded:false,logs:{}};return b;},remove_record_log:function(){var a=this.item._get_rec_change_id();if(a){this.find_record_log();delete this.logs[a];this.item._set_rec_change_id(null);this.item._set_record_status(d.RECORD_UNCHANGED);}},cur_record:function(){return this.item._dataset[this.item._get_rec_no()];},record_modified:function(a){var b=false,c=a.old_record,d=a.record;for(var e=0;e<this.item._record_lookup_index;e++)if(c[e]!==d[e]){b=true;break;}return b;},copy_record:function(a,b){var c=null,d;if(a){if(b===undefined)b=true;if(b)c=a.slice(0,this.item._record_info_index);else c=a.slice(0,this.item._record_lookup_index);d=this.item.get_rec_info(undefined,a);c.push([d[0],{},d[2]]);}return c;},can_log_changes:function(){var a=this.log_changes();if(this.item.item_state===d.STATE_EDIT){}},log_change:function(){var a;if(this.log_changes()){a=this.find_record_log();if(this.item.item_state===d.STATE_BROWSE){if((this.item._get_record_status()===d.RECORD_UNCHANGED)||(this.item._get_record_status()===d.RECORD_DETAILS_MODIFIED&&a.old_record===null)){a.old_record=this.copy_record(this.cur_record(),false);return;}}else if(this.item.item_state===d.STATE_INSERT)this.item._set_record_status(d.RECORD_INSERTED);else if(this.item.item_state===d.STATE_EDIT){if(this.item._get_record_status()===d.RECORD_UNCHANGED)this.item.record_status=d.RECORD_MODIFIED;else if(this.item._get_record_status()===d.RECORD_DETAILS_MODIFIED)if(this.record_modified(a))this.item._set_record_status(d.RECORD_MODIFIED);}else if(this.item.item_state===d.STATE_DELETE)if(this.item._get_record_status()===d.RECORD_INSERTED)this.remove_record_log();else this.item._set_record_status(d.RECORD_DELETED);else throw this.item.item_name+': change log invalid records state';if(this.item.master)if(this.item.master._get_record_status()===d.RECORD_UNCHANGED)this.item.master._set_record_status(d.RECORD_DETAILS_MODIFIED);}},get_changes:function(a){var b={},c,e,f=null,g,h,i,j,k,l,m,n;a.fields=this.fields;a.expanded=false;a.data=b;for(var o in this.logs)if(this.logs.hasOwnProperty(o)){c=this.logs[o];e=c.record;g=this.item.get_rec_info(undefined,e);if(g[d.REC_STATUS]!==d.RECORD_UNCHANGED){l=c.details;if(this.item.keep_history||this.item.master&&this.item.master.keep_history)f=c.old_record;h=this.copy_record(e,false);i={};for(var j in l)if(l.hasOwnProperty(j)){k=l[j];m={};n=this.item.item_by_ID(parseInt(j,10));n.change_log.logs=k.logs;n.change_log.get_changes(m);i[j]=m;}b[o]={record:h,details:i,old_record:f};}}},set_changes:function(a){var b=a.data,c,d,e,f,g,h;this.records=[];this.logs={};this.fields=a.fields;this.expanded=a.expanded;this._change_id=0;for(var i in b)if(b.hasOwnProperty(i)){c=b[i];if(this._change_id<parseInt(i,10))this._change_id=parseInt(i,10);d=c.record;this.records.push(d);f={};this.logs[i]={old_record:null,record:d,details:f};e=c.details;for(var j in e)if(e.hasOwnProperty(j)){g=e[j];h=this.item.item_by_ID(parseInt(j,10));h.change_log.set_changes(g);f[j]={logs:h.change_log.logs,records:h.change_log.records,fields:h.change_log.fields,expanded:h.change_log.expanded};}}},copy_records:function(a){var b=0,c=a.length,d=[];for(b=0;b<c;b++)d.push(a[b].slice(0));return d;},store_details:function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;for(var q=0;q<this.item.details.length;q++){c=this.item.details[q];o=c.ID;n=a[o];f={};h=[];k=[];l=true;if(n){d=n.logs;g=n.records;k=n.fields;l=n.expanded;h=this.copy_records(g);for(var r in d)if(d.hasOwnProperty(r)){e=d[r];i=e.record;j=c.change_log.copy_record(i);m=g.indexOf(i);if(m!==-1)h[m]=j;p={};c.change_log.store_details(e.details,p);f[r]={old_record:e.old_record,record:j,details:p};}}else if(c._dataset)h=this.copy_records(c._dataset);b[o]={logs:f,records:h,fields:k,expanded:l};}},store_record_log:function(){var a,b,c,d;if(this.log_changes()){a=this.find_record_log();b={};this.store_details(a.details,b);d={};d.old_record=a.old_record;d.record=this.copy_record(a.record);d.details=b;}else{d={};d.record=this.copy_record(this.cur_record());b={};for(var e=0;e<this.item.details.length;e++){c=this.item.details[e];if(!c.disabled&&c._dataset)b[c.ID]=c._dataset.slice(0);}d.details=b;}return d;},restore_record_log:function(a){var b,c,e,f,g,h;if(this.log_changes()){b=this.find_record_log();c=a.record;g=this.cur_record();h=this.item._record_info_index;for(var i=0;i<h;i++)g[i]=c[i];b.old_record=a.old_record;b.record=g;b.details=a.details;for(var i=0;i<this.item.details.length;i++){e=this.item.details[i];f=a.details[e.ID];if(!this.is_empty_obj(f))e._dataset=f.records;}if(this.item._get_record_status()===d.RECORD_UNCHANGED)this.remove_record_log();}else{c=a.record;g=this.cur_record();h=this.item._record_info_index;for(var i=0;i<h;i++)g[i]=c[i];for(var i=0;i<this.item.details.length;i++){e=this.item.details[i];e._dataset=a.details[e.ID];}}},update:function(a,b){var c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;if(a){e=a.changes;for(var t in e)if(e.hasOwnProperty(t)){c=e[t];f=c.log_id;g=c.rec_id;i=c.details;j=this.logs[f];if(j){k=j.record;l=j.details;m=i.length;for(var u=0;u<m;u++){h=i[u];n=h.ID;o=this.item.detail_by_ID(parseInt(n,10));p=l[n];if(!this.is_empty_obj(p)){o.change_log.logs=p.logs;o.change_log.update(h,g);}}if(g)if(!k[this.item._primary_key_field.bind_index])k[this.item._primary_key_field.bind_index]=g;if(b)if(!k[this.item._master_rec_id_field.bind_index])k[this.item._master_rec_id_field.bind_index]=b;q=this.item.get_rec_info(undefined,k);q[d.REC_STATUS]=d.RECORD_UNCHANGED;q[d.REC_CHANGE_ID]=d.RECORD_UNCHANGED;delete this.logs[f];}}}},prepare:function(){var a=this,b,c=this.item.fields.length;if(this.item.master)a=this.item.master.change_log.get_detail_log(this.item.ID);if(a){a.records=[];a.logs={};a.fields=[];for(b=0;b<c;b++)if(!this.item.fields[b].master_field)a.fields.push(this.item.fields[b].field_name);a.expanded=this.item.expanded;}}};k.prototype=new g();function k(b,c,d,e,f,h,i){var k;g.call(this,b,c,d,e,f,h,i);if(this.task&&h!==0&&!(d in this.task))this.task[d]=this;this.field_defs=[];this._fields=[];this.fields=[];this.filter_defs=[];this.filters=[];this.details=[];this.controls=[];this.change_log=new j(this);this.paginate=false;this.disabled=false;this.expanded=true;this._log_changes=true;this._dataset=null;this._eof=false;this._bof=false;this._cur_row=null;this._old_row=0;this._old_status=null;this._buffer=null;this._modified=null;this._state=0;this._read_only=false;this._parent_read_only=true;this._active=false;this._disabled_count=0;this._open_params={};this._where_list=[];this._order_by_list=[];this._select_field_list=[];this._record_lookup_index=-1;this._record_info_index=-1;this._is_delta=false;this._pg_limit=20;this._pg_offset=0;this.is_loaded=false;this.view_options=a.extend({},this.modal_options);this.view_options.width=960;this.edit_options=a.extend({},this.modal_options);this.filter_options=a.extend({},this.modal_options);Object.defineProperty(this,"rec_no",{get:function(){return this._get_rec_no();},set:function(a){this._set_rec_no(a);}});Object.defineProperty(this,"rec_count",{get:function(){return this.record_count();}});Object.defineProperty(this,"active",{get:function(){return this._get_active();}});Object.defineProperty(this,"read_only",{get:function(){return this._get_read_only();},set:function(a){this._set_read_only(a);}});Object.defineProperty(this,"filtered",{get:function(){return this._get_filtered();},set:function(a){this._set_filtered(a);}});Object.defineProperty(this,"item_state",{get:function(){return this._get_item_state();},set:function(a){this._set_item_state(a);}});Object.defineProperty(this,"record_status",{get:function(){return this._get_record_status();},set:function(a){this._set_record_status(a);}});Object.defineProperty(this,"default_field",{get:function(){return this.find_default_field();}});Object.defineProperty(this,"log_changes",{get:function(){return this._get_log_changes();},set:function(a){this._set_log_changes(a);}});Object.defineProperty(this,"dataset",{get:function(){return this.get_dataset();},set:function(a){this.set_dataset(a);}});}a.extend(k.prototype,{constructor:k,getChildClass:function(){return m;},initAttr:function(a){var b,c=a.fields,d=a.filters,e;if(c){e=c.length;for(b=0;b<e;b++){this.field_defs.push(c[b]);new n(this,c[b]);}}if(d){e=d.length;for(b=0;b<e;b++){this.filter_defs.push(d[b]);new o(this,d[b]);}}this.reports=a.reports;},bind_item:function(){var a=0,b,c;this.prepare_fields();this.init_options();this.prepare_filters();b=this.reports.length;c=this.reports;this.reports=[];for(a=0;a<b;a++)this.reports.push(this.task.item_by_ID(c[a]));},can_create:function(){return this.task.has_privilege(this,'can_create');},can_edit:function(){return this.task.has_privilege(this,'can_edit');},can_delete:function(){return this.task.has_privilege(this,'can_delete');},prepare_fields:function(){var a=0,b=this._fields.length,c;for(;a<b;a++){c=this._fields[a];if(c.lookup_item&&(typeof c.lookup_item==="number")){c.lookup_item=this.task.item_by_ID(c.lookup_item);if(c.lookup_field&&(typeof c.lookup_field==="number"))c.lookup_field=c.lookup_item._field_by_ID(c.lookup_field).field_name;}if(c.master_field&&(typeof c.master_field==="number"))c.master_field=this.get_master_field(this._fields,c.master_field);if(c.lookup_values&&(typeof c.lookup_values==="number"))c.lookup_values=self.task.lookup_lists[c.lookup_values];}this.fields=this._fields.slice(0);for(a=0;a<b;a++){c=this.fields[a];if(this[c.field_name]===undefined)this[c.field_name]=c;}},prepare_filters:function(){var a=0,b,c;b=this.filters.length;for(a=0;a<b;a++){c=this.filters[a].field;if(c.lookup_item&&(typeof c.lookup_item==="number"))c.lookup_item=this.task.item_by_ID(c.lookup_item);if(c.lookup_field&&(typeof c.lookup_field==="number"))c.lookup_field=c.lookup_item._field_by_ID(c.lookup_field).field_name;}},init_options:function(){var b,c=[],d=[],e=this._fields.length;for(b=0;b<e;b++){if(this._fields[b].view_visible&&this._fields[b].view_index!==-1)c.push(this._fields[b]);if(this._fields[b].edit_visible&&this._fields[b].edit_index!==-1)d.push(this._fields[b]);}c.sort(function(a,b){if(a.view_index>b.view_index===0)return 0;if(a.view_index>b.view_index)return 1;else return -1;});d.sort(function(a,b){if(a.edit_index>b.edit_index===0)return 0;if(a.edit_index>b.edit_index)return 1;else return -1;});this.view_options.fields=[];for(b=0;b<c.length;b++)this.view_options.fields.push(c[b].field_name);this.edit_options.fields=[];for(b=0;b<d.length;b++)this.edit_options.fields.push(d[b].field_name);this.edit_options.title=this.item_caption;this.view_options.title=this.item_caption;this._edit_options=a.extend({},this.edit_options);this._view_options=a.extend({},this.view_options);},each:function(a){var b;if(this._active){this.first();while(!this.eof()){b=a.call(this,this);if(b===false)break;else this.next();}}},each_field:function(a){var b=0,c=this.fields.length,d;for(;b<c;b++){d=a.call(this.fields[b],this.fields[b],b);if(d===false)break;}},each_filter:function(a){var b=0,c=this.filters.length,d;for(;b<c;b++){d=a.call(this.filters[b],this.filters[b],b);if(d===false)break;}},each_detail:function(a){var b=0,c=this.details.length,d;for(;b<c;b++){d=a.call(this.details[b],this.details[b],b);if(d===false)break;}},_field_by_name:function(a){return this.field_by_name(a,this._fields);},field_by_name:function(a,b){var c=0,d,e;if(b===undefined)b=this.fields;d=b.length;for(;c<d;c++)if(b[c].field_name===a)return b[c];return e;},_field_by_ID:function(a){return this.field_by_ID(a,this._fields);},field_by_ID:function(a,b){var c=0,d;if(b===undefined)b=this.fields;d=b.length;for(;c<d;c++)if(b[c].ID===a)return b[c];},filter_by_name:function(a){var b=0,c=this.filters.length;try{return this.filters[a];}catch(d){for(;b<c;b++)if(this.filters[b].filter_name===a)return this.filters[b];}},detail_by_name:function(a){var b=0,c=this.details.length;try{return this.details[a];}catch(d){for(;b<c;b++)if(this.details[b].item_name===a)return this.details[b];}},get_dataset:function(){var a,b,c=[];if(this.active){b=this._dataset.length;for(a=0;a<b;a++)c.push(this._dataset[a].slice(0,this._record_info_index));return c;}},set_dataset:function(a){this._dataset=a;},copy:function(a){if(this.master)throw 'A detail item can not be copied.';return this._copy(a);},_copy:function(b){var c,d,e,f,g,h,i={filters:true,details:true,handlers:true};h=new k(this.owner,this.ID,this.item_name,this.item_caption,this.visible,this.item_type_id);h.master=this.master;h.item_type=this.item_type;b=a.extend({},i,b);h.ID=this.ID;h.item_name=this.item_name;h.expanded=this.expanded;h.field_defs=this.field_defs;h.filter_defs=this.filter_defs;h._primary_key=this._primary_key;h._deleted_flag=this._deleted_flag;h._master_id=this._master_id;h._master_rec_id=this._master_rec_id;h._default_order=this._default_order;h._edit_options=this._edit_options;h._view_options=this._view_options;h.edit_options=a.extend({},this._edit_options);h.view_options=a.extend({},this._view_options);e=h.field_defs.length;for(d=0;d<e;d++)new n(h,h.field_defs[d]);h.prepare_fields();if(b.filters){e=h.filter_defs.length;for(d=0;d<e;d++)new o(h,h.filter_defs[d]);h.prepare_filters();}h._events=this._events;if(b.handlers){e=this._events.length;for(d=0;d<e;d++)h[this._events[d][0]]=this._events[d][1];}if(b.handlers)for(var j in this)if(this.hasOwnProperty(j))if((j.substring(0,3)==="on_")&&(typeof this[j]==="function"))h[j]=this[j];if(b.details)this.each_detail(function(a,d){c=a._copy(b);c.owner=h;c.expanded=a.expanded;c.master=h;c.item_type=a.item_type;h.details.push(c);h.items.push(c);if(!(c.item_name in h))h[c.item_name]=c;if(!(c.item_name in h.details))h.details[c.item_name]=c;});return h;},clone:function(a){var b,c,e,f,g;if(a===undefined)a=true;b=new k(this.owner,this.ID,this.item_name,this.item_caption,this.visible,this.item_type_id);b.master=this.master;b.item_type=this.item_type;b.ID=this.ID;b.item_name=this.item_name;b.field_defs=this.field_defs;b.filter_defs=this.filter_defs;e=b.field_defs.length;for(c=0;c<e;c++)f=new n(b,b.field_defs[c]);b.prepare_fields();e=b.fields.length;for(c=0;c<e;c++){f=b.fields[c];if(b[f.field_name]!==undefined)delete b[f.field_name];}b.fields=[];e=this.fields.length;for(c=0;c<e;c++){f=this.fields[c];g=b._field_by_name(f.field_name);b.fields.push(g);if(b[g.field_name]===undefined)b[g.field_name]=g;}b.update_system_fields();b._bind_fields();b._dataset=this._dataset;if(a){b.on_filter_record=this.on_filter_record;b.filtered=this.filtered;}b._active=true;b._set_item_state(d.STATE_BROWSE);b.first();return b;},store_handlers:function(){var a={};for(var b in this)if(this.hasOwnProperty(b))if((b.substring(0,3)==="on_")&&(typeof this[b]==="function"))a[b]=this[b];return a;},clear_handlers:function(){for(var a in this)if(this.hasOwnProperty(a))if((a.substring(0,3)==="on_")&&(typeof this[a]==="function"))this[a]=undefined;},load_handlers:function(a){for(var b in a)if(a.hasOwnProperty(b))this[b]=a[b];},_get_log_changes:function(){return this._log_changes;},_set_log_changes:function(a){this._log_changes=a;},is_modified:function(){return this._modified;},_set_modified:function(a){this._modified=a;if(this.master&&a)this.master._set_modified(a);}});a.extend(k.prototype,{_bind_fields:function(a){var b=0;if(a===undefined)a=true;this.each_field(function(a,b){a.bind_index=null;a.lookup_index=null;});this.each_field(function(a,c){if(!a.master_field){a.bind_index=b;b+=1;}});this.each_field(function(a,b){if(a.master_field)a.bind_index=a.master_field.bind_index;});this._record_lookup_index=b;if(a)this.each_field(function(a,c){if(a.lookup_item){a.lookup_index=b;b+=1;}});this._record_info_index=b;},set_fields:function(a){this._select_field_list=a;},set_order_by:function(a){this._order_by_list=this.get_order_by_list(a);},get_order_by_list:function(a){var b,c,d,e,f,g,h=[];g=a.length;for(f=0;f<g;f++){b=a[f];c=b;d=false;if(b[0]==='-'){d=true;c=b.substring(1);}try{e=this.field_by_name(c);}catch(i){throw this.item_name+': set_order_by method arument error - '+b+' '+i;}h.push([e.ID,d]);}return h;},set_where:function(a){this._where_list=this.get_where_list(a);},get_where_list:function(a){var b,c,e,g,h,i,j,k=[];for(c in a)if(a.hasOwnProperty(c)){e=c;i=a[c];j=c.indexOf('__');if(j>-1){h=c.substring(j+2);c=c.substring(0,j);}else h='eq';g=f.indexOf(h);if(g!==-1)g+=1;else throw this.item_name+': set_where method arument error - '+e;b=this._field_by_name(c);if(!b)throw this.item_name+': set_where method arument error - '+e;if(i!==null){if(b.data_type===d.DATETIME&&g!==d.FILTER_ISNULL)i=b.format_date_to_string(i,'%Y-%m-%d %H:%M:%S');k.push([c,g,i]);}}return k;},update_system_fields:function(){var a,b,c,d,e,f=['_primary_key','_deleted_flag','_master_id','_master_rec_id'];b=f.length;for(a=0;a<b;a++){e=f[a];d=this[e];if(d){c=this.field_by_name(d);if(c)this[e+'_field']=c;}}},_update_fields:function(a){var b,c,d;c=this.fields.length;for(b=0;b<c;b++){d=this.fields[b];if(this[d.field_name]!==undefined)delete this[d.field_name];}this.fields=[];if(a===undefined&&this._select_field_list.length)a=this._select_field_list;if(a){c=a.length;for(b=0;b<c;b++)this.fields.push(this._field_by_name(a[b]));}else this.fields=this._fields.slice(0);c=this.fields.length;for(b=0;b<c;b++){d=this.fields[b];if(this[d.field_name]===undefined)this[d.field_name]=d;}this.update_system_fields();},_do_before_open:function(a,b,c,e,f,g,h,i,j,k){var l=[];if(this.on_before_open)this.on_before_open.call(this,this,g);g.__expanded=a;g.__fields=[];if(b)g.__fields=b;this._update_fields(b);g.__open_empty=f;g.__order=[];if(!f){g.__limit=0;g.__offset=0;if(i){g.__limit=i;if(h)g.__offset=h;}if(c)l=this.get_where_list(c);else if(this._where_list.length)l=this._where_list.slice(0);else this.each_filter(function(a,b){if(a.get_value()!==null)l.push([a.field.field_name,a.filter_type,a.get_value()]);});if(g.__search!==undefined){var m=g.__search[0],n=g.__search[1];l.push([m,d.FILTER_CONTAINS_ALL,n]);}g.__filters=l;if(e)g.__order=this.get_order_by_list(e);else if(this._order_by_list.length)g.__order=this._order_by_list.slice(0);else if(this._default_order)g.__order=this._default_order.slice();this._where_list=[];this._order_by_list=[];if(j)g.__funcs=j;if(k)g.__group_by=k;}this._open_params=g;},_do_after_open:function(){if(this.on_after_open)this.on_after_open.call(this,this);},open_details:function(a){var b=this,c=0;function d(){c-=1;if(c===0)a.call(b);}if(a){this.each_detail(function(a,b){if(!a.disabled)c+=1;});this.each_detail(function(a,b){if(!a.disabled)a.open(d);});}else this.each_detail(function(a,b){if(!a.disabled)a.open();});},find_change_log:function(){if(this.master)if(this.master._get_record_status()!==d.RECORD_UNCHANGED)return this.master.change_log.get_detail_log(this.ID);},_check_open_options:function(b){if(b){if(b.fields&&!a.isArray(b.fields))throw this.item_name+': open method options error: the fields option must be an array.';if(b.order_by&&!a.isArray(b.order_by))throw this.item_name+': open method options error: the order_by option must be an array.';if(b.group_by&&!a.isArray(b.group_by))throw this.item_name+': open method options error: the group_by option must be an array.';}},open:function(){var a,b,c,e,f,g,h,i,j,k,l,c,m,n,o,p,q,r,s,t=this;for(a=0;a<arguments.length;a++)switch(typeof arguments[a]){case "function":c=arguments[a];break;case "object":b=arguments[a];break;}this._check_open_options(b);if(b){e=b.expanded;f=b.fields;g=b.where;h=b.order_by;i=b.open_empty;l=b.params;p=b.offset;o=b.limit;j=b.funcs;k=b.group_by;}if(!l)l={};if(e===undefined)e=this.expanded;else this.expanded=e;m=c?true:false;if(this.master)if(!this.disabled&&this.master.record_count()>0){l.__master_id=this.master.ID;l.__master_rec_id=this.master.field_by_name(this.master._primary_key).value;if(this.master.is_new())s=[];else{n=this.find_change_log();if(n){s=n.records;f=n.fields;e=n.expanded;}}if(s!==undefined){this._do_before_open(e,f,g,h,i,l,p,o,j,k);this._bind_fields(e);if(this.master.is_new())this.change_log.prepare();this._dataset=s;this._active=true;this._set_item_state(d.STATE_BROWSE);this.first();this._do_after_open();this.update_controls(d.UPDATE_OPEN);if(c)c.call(this,this);return;}}else{this.close();return;}if(this.paginate&&p!==undefined){l=this._open_params;l.__offset=p;if(this.on_before_open)this.on_before_open.call(this,this,l);}else{p=0;this._do_before_open(e,f,g,h,i,l,p,o,j,k);this._bind_fields(e);}if(this.paginate)l.__limit=this._pg_limit;this.change_log.prepare();this._dataset=[];this.do_open(p,m,l,i,function(){t._active=true;t._set_item_state(d.STATE_BROWSE);t._cur_row=null;t.first();t._do_after_open();if((!t.paginate||t.paginate&&p===0)&&t.on_filters_applied)t.on_filters_applied.call(t,t);t.update_controls(d.UPDATE_OPEN);if(c)c.call(t,t);});},do_open:function(a,b,c,d,e){var f=this,g;if(b&&!d)this.send_request('open',c,function(b){f._do_after_load(b,a,e);});else{if(d)g=[[],''];else g=this.send_request('open',c);this._do_after_load(g,a,e);}},_do_after_load:function(a,b,c){var d,e,f,g;if(a){e=a[1];if(e)this.warning(e);else if(a[0]){d=a[0];g=d.length;this._dataset=d;if(this._pg_limit&&this.paginate&&d){this._pg_offset=b;this.is_loaded=false;}if(g<this._pg_limit)this.is_loaded=true;c.call(this,this);}}else{this._dataset=[];console.log(this.item_name+" error while opening table");}},_do_close:function(){this._active=false;this._dataset=null;this._cur_row=null;},close:function(){var a=this.details.length;this._do_close();for(var b=0;b<a;b++)this.details[b].close();this.update_controls(d.UPDATE_CLOSE);},sort:function(a){var b=this.get_order_by_list(a);this._sort(b);},_sort:function(a){var b,c=[],d=[];for(b=0;b<a.length;b++){c.push(this.field_by_ID(a[b][0]).field_name);d.push(a[b][1]);}this._sort_dataset(c,d);},_sort_dataset:function(a,b){var c=this,e,f,g;function h(a,b){if(a===null)if(b===d.TEXT)a='';else if(b===d.INTEGER||b===d.FLOAT||b===d.CURRENCY)a=0;else if(b===d.DATE||b===d.DATETIME)a=new Date(0);else if(b===d.BOOLEAN)a=false;if(b===d.FLOAT)a=Number(a.toFixed(10));if(b===d.CURRENCY)a=Number(a.toFixed(2));return a;}function i(d,e){var f,g,i,j,k,l,m;for(var f=0;f<a.length;f++){g=c.field_by_name(a[f]);j=g.bind_index;if(g.lookup_item)j=g.lookup_index;i=g.get_lookup_data_type();l=h(d[j],i);m=h(e[j],i);if(l<m)k=-1;if(l>m)k=1;if(k){if(b[f])k=-k;return k;}}return 0;}this._dataset.sort(i);this.update_controls();},search:function(a,b,c){var d=b.trim(),e={};if(d.length){e.__search=[a,d];this.open({params:e},c);}else this.open();},total_records:function(a){var b=this;if(this._open_params.__open_empty&&a)return 0;else this.send_request('get_record_count',this._open_params,function(c){if(c&&a)a.call(b,c[0]);});},new_record:function(){var a=[];this.each_field(function(b,c){if(!b.master_field)a.push(null);});if(this.expanded)this.each_field(function(b,c){if(b.lookup_item)a.push(null);});return a;},_do_before_append:function(){if(this.on_before_append)this.on_before_append.call(this,this);},_do_after_append:function(){var a=0,b=this.fields.length,c;for(;a<b;a++){c=this.fields[a];if(c.default_value)try{c.text=c.default_value;}catch(d){}}this._modified=false;if(this.on_after_append)this.on_after_append.call(this,this);},append:function(){if(!this._active)throw this.item_name+": can't append record - item is not active";if(this.master&&!this.master.is_changing())throw this.item_name+": can't append record - master item is not in edit or insert mode";if(this._get_item_state()!==d.STATE_BROWSE)throw this.item_name+": can't append record - item is not in browse mode";this._do_before_append();this._do_before_scroll();this._old_row=this._get_rec_no();this._set_item_state(d.STATE_INSERT);this._dataset.push(this.new_record());this._cur_row=this._dataset.length-1;this._set_record_status(d.RECORD_INSERTED);this.update_controls(d.UPDATE_APPEND);this._do_after_scroll();this._do_after_append();},insert:function(){if(!this._active)throw this.item_name+": can't insert record - item is not active";if(this.master&&!this.master.is_changing())throw this.item_name+": can't insert record - master item is not in edit or insert mode";if(this._get_item_state()!==d.STATE_BROWSE)throw this.item_name+": can't insert record - item is not in browse mode";this._do_before_append();this._do_before_scroll();this._old_row=this._get_rec_no();this._set_item_state(d.STATE_INSERT);this._dataset.splice(0,0,this.new_record());this._cur_row=0;this._modified=false;this._set_record_status(d.RECORD_INSERTED);this.update_controls(d.UPDATE_INSERT);this._do_after_scroll();this._do_after_append();},_do_before_edit:function(){if(this.on_before_edit)this.on_before_edit.call(this,this);},_do_after_edit:function(){if(this.on_after_edit)this.on_after_edit.call(this,this);},edit:function(){if(!this._active)throw this.item_name+": can't edit record - item is not active";if(this.record_count()===0)throw this.item_name+": can't edit record - item record list is empty";if(this.master&&!this.master.is_changing())throw this.item_name+": can't edit record - master item is not in edit or insert mode";if(this._get_item_state()!==d.STATE_BROWSE)throw this.item_name+": can't edit record - item is not in browse mode";this._do_before_edit();this.change_log.log_change();this._buffer=this.change_log.store_record_log();this._set_item_state(d.STATE_EDIT);this._old_row=this._get_rec_no();this._old_status=this._get_record_status();this._modified=false;this._do_after_edit();},_do_before_cancel:function(){if(this.on_before_cancel)this.on_before_cancel.call(this,this);},_do_after_cancel:function(){if(this.on_after_cancel)this.on_after_cancel.call(this,this);},cancel:function(){var a,b,c,e;c=this._get_rec_no();this._do_before_cancel();if(this._get_item_state()===d.STATE_EDIT){this.change_log.restore_record_log(this._buffer);this.update_controls(d.UPDATE_CANCEL);for(var a=0;a<this.details.length;a++)this.details[a].update_controls(d.UPDATE_OPEN);}else if(this._get_item_state()===d.STATE_INSERT){this.change_log.remove_record_log();this.update_controls(d.UPDATE_DELETE);this._dataset.splice(c,1);}else throw this.item_name+' cancel error: invalid item state';e=this._get_item_state();this._set_item_state(d.STATE_BROWSE);if(e===d.STATE_INSERT)this._do_before_scroll();this._cur_row=this._old_row;if(e===d.STATE_EDIT)this._set_record_status(this._old_status);this._modified=false;if(e===d.STATE_INSERT)this._do_after_scroll();this._do_after_cancel();},is_browsing:function(){return this._get_item_state()===d.STATE_BROWSE;},is_changing:function(){return(this._get_item_state()===d.STATE_INSERT)||(this._get_item_state()===d.STATE_EDIT);},is_new:function(){return this._get_item_state()===d.STATE_INSERT;},is_edited:function(){return this._get_item_state()===d.STATE_EDIT;},is_deleting:function(){return this._get_item_state()===d.STATE_DELETE;},_do_before_delete:function(a){if(this.on_before_delete)this.on_before_delete.call(this,this);},_do_after_delete:function(){if(this.on_after_delete)this.on_after_delete.call(this,this);},"delete":function(){var a=this._get_rec_no();if(!this._active)throw this.item_name+": can't delete record - item is not active";if(this.record_count()===0)throw this.item_name+": can't delete record - item record list is empty";if(this.master&&!this.master.is_changing())throw this.item_name+": can't delete record - master item is not in edit or insert mode";this._set_item_state(d.STATE_DELETE);try{this._do_before_delete();this._do_before_scroll();this.update_controls(d.UPDATE_DELETE);this.change_log.log_change();if(this.master)this.master._set_modified(true);this._dataset.splice(a,1);this._set_rec_no(a);this._do_after_scroll();this._set_item_state(d.STATE_BROWSE);this._do_after_delete();}finally{this._set_item_state(d.STATE_BROWSE);}},detail_by_ID:function(a){var b;if(typeof a==="string")a=parseInt(a,10);this.each_detail(function(c,d){if(c.ID===a){b=c;return false;}});return b;},post:function(a){var b,c,e,f=this._get_item_state();if(!this.is_changing())throw this.item_name+' post method: dataset is not in edit or insert mode';if(this.on_before_post)this.on_before_post.call(this,this);if(this.master)this.field_by_name(this._master_id).set_data(this.master.ID);this.check_record_valid();e=this.details.length;for(c=0;c<e;c++)if(this.details[c].is_changing())this.details[c].post();if(this.is_modified()||this.is_new())this.change_log.log_change();else if(this._get_record_status()===d.RECORD_UNCHANGED)this.change_log.remove_record_log();this._modified=false;this._set_item_state(d.STATE_BROWSE);if(this.on_after_post)this.on_after_post.call(this,this);if(!this._valid_record()){this.update_controls(d.UPDATE_DELETE);this._search_record(this._get_rec_no(),0);}},apply:function(){var a=0,b=arguments.length,c=this,d={},e,f,g,h,g=true;for(;a<b;a++)switch(typeof arguments[a]){case "function":e=arguments[a];break;case "object":f=arguments[a];break;}if(this.master){if(e)e.call(this);return;}if(this.is_changing())this.post();this.change_log.get_changes(d);if(!this.change_log.is_empty_obj(d.data)){if(this.on_before_apply){g=this.on_before_apply.call(this,this);if(g)f=g;}if(e)this.send_request('apply_changes',[d,f],function(a){c._process_apply(a,e);});else{h=this.send_request('apply_changes',[d,f]);g=this._process_apply(h);}}else if(e)e.call(this);},_process_apply:function(a,b){var c,d;if(a){c=a[0];d=a[1];if(d){if(b)b.call(this,d);throw d;}else{this.change_log.update(c);if(this.on_after_apply)this.on_after_apply.call(this,this);if(b)b.call(this);}}},delta:function(a){var b,c,e,f;if(a===undefined){a={};this.change_log.get_changes(a);}f=this.copy({filters:false,details:true,handlers:false});f.on_after_scroll=function(a){a.open_details();};f.expanded=false;f._is_delta=true;c=f.details.length;for(b=0;b<c;b++){f.details[b].expanded=false;f.details[b]._is_delta=true;}f.change_log.set_changes(a);f._dataset=f.change_log.records;f._update_fields(f.change_log.fields);f._bind_fields(f.change_log.expanded);f._set_item_state(d.STATE_BROWSE);f._cur_row=null;f._active=true;f.first();return f;},field_by_id:function(a,b,c){var d,e,f;if(typeof b==='string')b=[b];d=this.copy();d.set_where({id:a});if(c){d.open({expanded:false,fields:b},function(){e=d._dataset[0];if(b.length===1)e=e[0];return e;});}else{d.open({expanded:false,fields:b});if(d.record_count()===1){e=d._dataset[0];if(b.length===1)e=e[0];return e;}}},locate:function(a,b){var c=this.clone();function d(){var d,e;if(a instanceof Array){e=a.length;for(d=0;d<e;d++)if(c.field_by_name(a[d]).value!==b[d])return false;return true;}else if(c.field_by_name(a).value===b)return true;}c.first();while(!c.eof()){if(d()){this.rec_no=c.rec_no;return true;}c.next();}}});a.extend(k.prototype,{_get_active:function(){return this._active;},_set_read_only:function(a){var b,c;this._read_only=a;c=this.fields.length;for(b=0;b<c;b++)this.fields[b].update_controls();this.each_detail(function(b,c){b._set_read_only(a);});},_get_read_only:function(){if(this.master&&this._parent_read_only)return this.master._get_read_only();else return this._read_only;},_get_filtered:function(){return this._filtered;},_set_filtered:function(a){if(a)if(!this.on_filter_record)a=false;if(this._filtered!==a){this._filtered=a;this.first();this.update_controls(d.UPDATE_OPEN);}},clear_filters:function(){this.each_filter(function(a){a.value=null;});},assign_filters:function(a){var b=this;a.each_filter(function(a){if(a.value===null)b.filter_by_name(a.filter_name).field.value=null;else b.filter_by_name(a.filter_name).field.value=a.field.value;});},_set_item_state:function(a){if(this._state!==a){this._state=a;if(this.on_state_changed)this.on_state_changed.call(this,this);}},_get_item_state:function(){return this._state;},_do_after_scroll:function(){var a=this.details.length;for(var b=0;b<a;b++)this.details[b]._do_close();this.update_controls(d.UPDATE_SCROLLED);if(this.on_after_scroll)this.on_after_scroll.call(this,this);},_do_before_scroll:function(){if(this._cur_row!==null){if(this.is_changing())this.post();if(this.on_before_scroll)this.on_before_scroll.call(this,this);}},skip:function(a){var b,c,d,e;if(this.record_count()===0){this._do_before_scroll();this._eof=true;this._bof=true;this._do_after_scroll();}else{d=this._cur_row;b=false;c=false;e=a;if(e<0){e=0;c=true;}if(e>=this._dataset.length){e=this._dataset.length-1;b=true;}this._eof=b;this._bof=c;if(d!==e){this._do_before_scroll();this._cur_row=e;this._do_after_scroll();}else if(b||c&&this.is_new()&&this.record_count()===1){this._do_before_scroll();this._do_after_scroll();}}},_set_rec_no:function(a){if(this._active)if(this.filter_active())this._search_record(a,0);else this.skip(a);},_get_rec_no:function(){if(this._active)return this._cur_row;},filter_active:function(){if(this.on_filter_record&&this.filtered)return true;},first:function(){if(this.filter_active())this.find_first();else this._set_rec_no(0);},last:function(){if(this.filter_active())this.find_last();else this._set_rec_no(this._dataset.length);},next:function(){if(this.filter_active())this.find_next();else this._set_rec_no(this._get_rec_no()+1);},prior:function(){if(this.filter_active())this.find_prior();else this._set_rec_no(this._get_rec_no()-1);},eof:function(){return this._eof;},bof:function(){return this._bof;},_valid_record:function(){if(this.on_filter_record&&this.filtered)return this.on_filter_record.call(this,this);else return true;},_search_record:function(a,b){var c,d,e=this;if(b===undefined)b=1;function f(){if(e.record_count()===0){e._eof=true;e._bof=true;}else{e._eof=false;e._bof=false;if(e._cur_row<0){e._cur_row=0;e._bof=true;}if(e._cur_row>=e._dataset.length){e._cur_row=e._dataset.length-1;e._eof=true;}}}function g(){if(b===1)return e.eof();else return e.bof();}if(this.active){if(this.record_count()===0){this.skip(a);return;}d=this._cur_row;this._cur_row=a+b;f();if(b===0){if(this._valid_record()){this._cur_row=d;this.skip(a);return;}b=1;}while(!g())if(this._valid_record()){if(a!==this._cur_row){c=this._cur_row;this._cur_row=a;this.skip(c);return;}}else{this._cur_row=this._cur_row+b;f();}}},find_first:function(){this._search_record(-1,1);},find_last:function(){this._search_record(this._dataset.length,-1);},find_next:function(){this._search_record(this._get_rec_no(),1);},find_prior:function(){this._search_record(this._get_rec_no(),-1);},record_count:function(){if(this._dataset)return this._dataset.length;else return 0;},find_rec_info:function(a,b){if(b===undefined)if(a===undefined){a=this._get_rec_no();if(this.record_count()>0)b=this._dataset[a];}if(b&&(this._record_info_index>0)){if(b.length<this._record_info_index+1)b.push([null,{},null]);return b[this._record_info_index];}},get_rec_info:function(a,b){return this.find_rec_info(a,b);},_get_record_status:function(){var a=this.get_rec_info();if(a)return a[d.REC_STATUS];},_set_record_status:function(a){var b=this.get_rec_info();if(b&&this.log_changes)b[d.REC_STATUS]=a;},rec_controls_info:function(){var a=this.get_rec_info();if(a)return a[d.REC_CONTROLS_INFO];},_get_rec_change_id:function(){var a=this.get_rec_info();if(a)return a[d.REC_CHANGE_ID];},_set_rec_change_id:function(a){var b=this.get_rec_info();if(b)b[d.REC_CHANGE_ID]=a;},rec_unchanged:function(){return this._get_record_status()===d.RECORD_UNCHANGED;},rec_inserted:function(){return this._get_record_status()===d.RECORD_INSERTED;},rec_deleted:function(){return this._get_record_status()===d.RECORD_DELETED;},rec_modified:function(){return this._get_record_status()===d.RECORD_MODIFIED||this._get_record_status()===d.RECORD_DETAILS_MODIFIED;}});a.extend(k.prototype,{insert_record:function(a){if(this.can_create()){if(!this.is_changing())this.insert();this.create_edit_form(a);}},append_record:function(a){if(this.can_create()){if(!this.is_changing())this.append();this.create_edit_form(a);}},edit_record:function(a){if(this.can_edit()){if(!this.is_changing())this.edit();this.create_edit_form(a);}},copy_record:function(a){function b(a){var b={};a.each_field(function(a){if(!a.system_field())b[a.field_name]=[a.value,a.lookup_value];});return b;}function c(a,b){for(var c in b)if(b.hasOwnProperty(c)){a.field_by_name(c).value=b[c][0];a.field_by_name(c).lookup_value=b[c][1];}}var d={},e=[],f,g,h;if(this.can_create()){d=b(this);this.each_detail(function(a){var c=[];if(a.record_count()){a.each(function(a){c.push(b(a));});e[a.ID]=c;}});this.append();c(this,d);for(var i in e)if(e.hasOwnProperty(i)){g=this.item_by_ID(parseInt(i,10));h=e[i];g.open();for(f=0;f<h.length;f++){g.append();c(g,h[f]);g.post();}}if(a)a.call(this,this);this.create_edit_form();}},cancel_edit:function(){this.close_edit_form();this.cancel();},delete_record:function(a){var b=this,d=b._get_rec_no(),e=b._dataset[d],f;if(this.can_delete())if(this.record_count()>0){this.question(c.delete_record,function(){b["delete"]();try{b.apply();}catch(g){f=(g+'').toUpperCase();if(f&&(f.indexOf('FOREIGN KEY')!==-1||f.indexOf('INTEGRITY CONSTRAINT')!==-1)&&(f.indexOf('VIOLAT')!==-1||f.indexOf('FAIL')!==-1))b.warning(c.cant_delete_used_record);else b.warning(g);b._dataset.splice(d,0,e);b._cur_row=d;b.change_log.remove_record_log();b.update_controls();b._do_after_scroll();if(a)a.call(this,this);}});}else this.warning(c.no_record);},check_record_valid:function(){var a;this.each_field(function(b,c){try{b.check_valid();}catch(d){b.update_control_state(d);if(!a)a='Field "'+b.field_name+'": '+d;}});if(a)throw a;},check_filters_valid:function(){var a;this.each_filter(function(b,c){try{b.check_valid();}catch(d){b.field.update_control_state(d);if(b.field1)b.field1.update_control_state(d);if(!a)a=d;}});if(a)throw a;},post_record:function(){this.post();this.close_edit_form();},apply_record:function(){var a,b,c,d=this;for(a=0;a<arguments.length;a++)switch(typeof arguments[a]){case "function":b=arguments[a];break;case "object":c=arguments[a];break;}this.post();this.apply(c,function(a){if(a){d.warning(a);if(!d.is_changing())d.edit();}else{if(b)b.call(d,d);d.close_edit_form();}});},do_on_view_keyup:function(a){if(this.task.on_view_form_keyup)this.task.on_view_form_keyup.call(this,this,a);if(this.owner.on_view_form_keyup)this.owner.on_view_form_keyup.call(this,this,a);if(this.on_view_form_keyup)this.on_view_form_keyup.call(this,this,a);},do_on_view_keydown:function(a){if(this.task.on_view_form_keydown)this.task.on_view_form_keydown.call(this,this,a);if(this.owner.on_view_form_keydown)this.owner.on_view_form_keydown.call(this,this,a);if(this.on_view_form_keydown)this.on_view_form_keydown.call(this,this,a);},view_modal:function(a){this.is_lookup_item=true;this.view(a);},view:function(a){var b=this;this.load_modules([this,this.owner],function(){b._view(a);});},_view:function(a){var b=this;this.create_form('view',{container:a,beforeShow:function(){if(this.task.on_view_form_created)this.task.on_view_form_created.call(this,this);if(!this.master&&this.owner.on_view_form_created)this.owner.on_view_form_created.call(this,this);if(this.on_view_form_created)this.on_view_form_created.call(this,this);},onShown:function(){if(b.task.on_view_form_shown)b.task.on_view_form_shown.call(b,b);if(!this.master&&b.owner.on_view_form_shown)b.owner.on_view_form_shown.call(b,b);if(b.on_view_form_shown)b.on_view_form_shown.call(b,b);},onHide:function(a){var c,d;if(b.on_view_form_close_query)d=b.on_view_form_close_query.call(b,b);if(!this.master&&d===undefined&&b.owner.on_view_form_close_query&&!b.master)d=b.owner.on_view_form_close_query.call(b,b);if(d===undefined&&b.task.on_view_form_close_query)d=b.task.on_view_form_close_query.call(b,b);return d;},onHidden:function(){if(b.task.on_view_form_closed)b.task.on_view_form_closed.call(b,b);if(!this.master&&b.owner.on_view_form_closed)b.owner.on_view_form_closed.call(b,b);if(b.on_view_form_closed)b.on_view_form_closed.call(b,b);},onKeyUp:this.do_on_view_keyup,onKeyDown:this.do_on_view_keydown});},close_view_form:function(){this.close_form('view_form');},do_on_edit_keyup:function(a){if(this.task.on_edit_form_keyup)this.task.on_edit_form_keyup.call(this,this,a);if(this.owner.on_edit_form_keyup)this.owner.on_edit_form_keyup.call(this,this,a);if(this.on_edit_form_keyup)this.on_edit_form_keyup.call(this,this,a);},do_on_edit_keydown:function(a){if(this.task.on_edit_form_keydown)this.task.on_edit_form_keydown.call(this,this,a);if(this.owner.on_edit_form_keydown)this.owner.on_edit_form_keydown.call(this,this,a);if(this.on_edit_form_keydown)this.on_edit_form_keydown.call(this,this,a);},create_edit_form:function(){var a=this,b,c,d=arguments.length;if(d)for(var e=0;e<d;e++)if(!b&&arguments[e] instanceof jQuery)b=arguments[e];else if(!c&&typeof arguments[e]==="function")c=arguments[e];this.edit_options.show_history=true;this.create_form('edit',{container:b,beforeShow:function(){if(a.task.on_edit_form_created)a.task.on_edit_form_created.call(a,a);if(!a.master&&a.owner.on_edit_form_created&&!a.master)a.owner.on_edit_form_created.call(a,a);if(a.on_edit_form_created)a.on_edit_form_created.call(a,a);},onShown:function(){if(a.task.on_edit_form_shown)a.task.on_edit_form_shown.call(a,a);if(!a.master&&a.owner.on_edit_form_shown&&!a.master)a.owner.on_edit_form_shown.call(a,a);if(a.on_edit_form_shown)a.on_edit_form_shown.call(a,a);if(c)c.call(a);},onHide:function(b){var c,d;if(a.on_edit_form_close_query)d=a.on_edit_form_close_query.call(a,a);if(!a.master&&d===undefined&&a.owner.on_edit_form_close_query&&!a.master)d=a.owner.on_edit_form_close_query.call(a,a);if(d===undefined&&a.task.on_edit_form_close_query)d=a.task.on_edit_form_close_query.call(a,a);return d;},onHidden:function(){if(a.task.on_edit_form_closed)a.task.on_edit_form_closed.call(a,a);if(!this.master&&a.owner.on_edit_form_closed)a.owner.on_edit_form_closed.call(a,a);if(a.on_edit_form_closed)a.on_edit_form_closed.call(a,a);},onKeyUp:this.do_on_edit_keyup,onKeyDown:this.do_on_edit_keydown});},close_edit_form:function(){this.close_form('edit_form');},create_filter_form:function(){var a=this,b,c,d=arguments.length;if(d)for(var e=0;e<d;e++)if(!b&&arguments[e] instanceof jQuery)b=arguments[e];else if(!c&&typeof arguments[e]==="function")c=arguments[e];this.create_form('filter',{container:b,beforeShow:function(){if(a.task.on_filter_form_created)a.task.on_filter_form_created.call(a,a);if(!a.master&&a.owner.on_filter_form_created)a.owner.on_filter_form_created.call(a,a);if(a.on_filter_form_created)a.on_filter_form_created.call(a,a);},onShown:function(){if(a.task.on_filter_form_shown)a.task.on_filter_form_shown.call(a,a);if(!a.master&&a.owner.on_filter_form_shown&&!a.master)a.owner.on_filter_form_shown.call(a,a);if(a.on_filter_form_shown)a.on_filter_form_shown.call(a,a);},onHide:function(b){var c,d;if(a.on_filter_form_close_query)d=a.on_filter_form_close_query.call(a,a);if(!a.master&&d===undefined&&a.owner.on_filter_form_close_query)d=a.owner.on_filter_form_close_query.call(a,a);if(d===undefined&&a.task.on_filter_form_close_query)d=a.task.on_filter_form_close_query.call(a,a);return d;},onHidden:function(){if(a.task.on_filter_form_closed)a.task.on_filter_form_closed.call(a,a);if(!this.master&&a.owner.on_filter_form_closed)a.owner.on_filter_form_closed.call(a,a);if(a.on_filter_form_closed)a.on_filter_form_closed.call(a,a);}});},close_filter_form:function(){this.close_form('filter_form');},apply_filters:function(){try{if(this.on_filters_apply)this.on_filters_apply.call(this,this);this.check_filters_valid();this.open();this.close_filter_form();}catch(a){}},get_filter_text:function(){var a='';this.each_filter(function(b){if(b.text)a+=' '+b.text;});if(a)a=c.filter+' -'+a;return a;},close_filter:function(){this.close_filter_form();},disable_controls:function(){this._disabled_count-=1;},enable_controls:function(){this._disabled_count+=1;if(this.controls_enabled())this.update_controls(d.UPDATE_SCROLLED);},controls_enabled:function(){return this._disabled_count===0;},controls_disabled:function(){return !this.controls_enabled();},update_controls:function(a){var b=0,c=this.fields.length;if(a===undefined)a=d.UPDATE_CONTROLS;if(this.controls_enabled()){for(b=0;b<c;b++)this.fields[b].update_controls(true);c=this.controls.length;if(this.on_update_controls)this.on_update_controls.call(this,this);for(b=0;b<c;b++)this.controls[b].update(a);}},create_table:function(a,b){return new r(this,a,b);},create_tree:function(a,b,c,d,e){return new q(this,a,b,c,d,e);},create_inputs:function(b,c){var d,e,f,g,h,i=[],j=[],k=[],l,m;d={fields:[],col_count:1,label_on_top:false,row_count:undefined,autocomplete:false,tabindex:undefined};if(!b)return;c=a.extend({},d,c);if(c.fields.length)j=c.fields;else j=this.edit_options.fields;f=j.length;for(e=0;e<f;e++){h=this.field_by_name(j[e]);if(h)i.push(h);else throw this.item_name+' create_entries: there is not a field with field_name - "'+j.fields[e]+'"';}b.empty();m=a('<form class="row-fluid" autocomplete="off"></form>').appendTo(a("<div></div>").appendTo(b));if(c.autocomplete)m.attr("autocomplete","on");if(!c.label_on_top)m.addClass("form-horizontal");f=i.length;for(g=0;g<c.col_count;g++)k.push(a("<div></div>").addClass("span"+12/c.col_count).appendTo(m));l=c.tabindex;if(!l&&this.edit_form){l=this.edit_form.tabindex;this.edit_form.tabindex+=f;}if(!c.row_count)c.row_count=Math.ceil(f/c.col_count);for(e=0;e<f;e++)new u(i[e],e+l,k[Math.floor(e/c.row_count)],c.label_on_top);},create_filter_inputs:function(b,e){var f,g,h,i,j,k=[],l=[],m,n;f={filters:[],col_count:1,label_on_top:false,autocomplete:false,tabindex:undefined},e=a.extend({},f,e);if(e.filters.length){h=e.filters.length;for(g=0;g<h;g++)k.push(this.filter_by_name(e.filters[g]));}else this.each_filter(function(a,b){if(a.visible)k.push(a);});b.empty();n=a('<form autocomplete="off"></form>').appendTo(a("<div></div>").addClass("row-fluid").appendTo(b));if(e.autocomplete)n.attr("autocomplete","on");if(!e.label_on_top)n.addClass("form-horizontal");h=k.length;for(i=0;i<e.col_count;i++)l.push(a("<div></div>").addClass("span"+12/e.col_count).appendTo(n));m=e.tabindex;if(!m&&this.filter_form){m=this.filter_form.tabindex;this.filter_form.tabindex+=h;}for(g=0;g<h;g++){j=k[g];if(j.filter_type===d.FILTER_RANGE){new u(j.field,g+1,l[Math.floor(g%e.col_count)],e.label_on_top,j.filter_caption+' '+c.range_from);new u(j.field1,g+1,l[Math.floor(g%e.col_count)],e.label_on_top,j.filter_caption+' '+c.range_to);}else new u(j.field,g+1,l[Math.floor(g%e.col_count)],e.label_on_top,j.filter_caption);}},set_lookup_field_value:function(){if(this.record_count()){var a=this.lookup_field,b=this.field_by_name(a.lookup_field),c=null,e=this.lookup_field.owner,f=[],g={},h=this;if(b)c=b.get_value();if(a.owner&&a.owner.is_changing&&!a.owner.is_changing())a.owner.edit();if(a.filter&&a.filter.filter_type===d.FILTER_IN)a.set_value([this._primary_key_field.value],c);else{if(e)e.each_field(function(c){if(c.master_field===a){b=h.field_by_name(c.lookup_field);if(b)g[c.field_name]=b.value;}});a.set_value(this._primary_key_field.value,c,g,this);}}if(this.lookup_field)this.close_view_form();},find_default_field:function(){var a=0,b=this.fields.length;for(;a<b;a++)if(this.fields[a].is_default)return this.fields[a];},set_edit_fields:function(a){this.edit_options.fields=a;},set_view_fields:function(a){this.view_options.fields=a;},round:function(a,b){return Number(a.toFixed(b));},refresh:function(a){},_do_on_refresh_record:function(a,b){var c,e;if(a.record_count()===1){e=a._dataset[0].length;for(c=0;c<e;c++)this._dataset[this.rec_no][c]=a._dataset[0][c];this.update_controls(d.UPDATE_CANCEL);if(b)b.call(this,this);}},refresh_record:function(a){var b=this,c=[],d=this._primary_key,e={},f;if(this.master)throw 'The refresh_record method can not be executed for a detail item';f=this.copy({filters:false,details:false,handlers:false});if(this._primary_key_field.value!==null){b.each_field(function(a){c.push(a.field_name);});e[d]=this._primary_key_field.value;if(a)f.open({expanded:this.expanded,fields:c,where:e},function(){b._do_on_refresh_record(f,a);});else{f.open({expanded:this.expanded,fields:c,where:e});this._do_on_refresh_record(f);}}}});l.prototype=new g();function l(b,c,e,f,h,i,j){g.call(this,b,c,e,f,h,i,j);if(this.task&&!(e in this.task))this.task[e]=this;this._fields=[];this.params=this._fields;this._state=d.STATE_EDIT;this.param_options=a.extend({},this.modal_options);}a.extend(l.prototype,{constructor:l,_set_item_state:function(a){if(this._state!==a)this._state=a;},_get_item_state:function(){return this._state;},initAttr:function(a){var b,c=a.fields,d;if(c){d=c.length;for(b=0;b<d;b++)new p(this,c[b]);}},bind_item:function(){var a=0,b,c=this.params.length;for(a=0;a<c;a++){b=this.params[a];if(b.lookup_item&&(typeof b.lookup_item==="number"))b.lookup_item=this.task.item_by_ID(b.lookup_item);if(b.lookup_field&&(typeof b.lookup_field==="number"))b.lookup_field=b.lookup_item._field_by_ID(b.lookup_field).field_name;if(b.lookup_values&&(typeof b.lookup_values==="number"))b.lookup_values=self.task.lookup_lists[b.lookup_values];}this.param_options.title=this.item_caption;},eachParam:function(a){var b=0,c=this.params.length,d;for(;b<c;b++){d=a.call(this.params[b],this.params[b],b);if(d===false)break;}},each_field:function(a){this.eachParam(a);},param_by_name:function(a){var b=0,c=this.params.length;for(;b<c;b++)if(this.params[b].param_name===a)return this.params[b];},create_param_form:function(){var a=this,b,c,d=arguments.length;if(d)for(var e=0;e<d;e++)if(!b&&arguments[e] instanceof jQuery)b=arguments[e];else if(!c&&typeof arguments[e]==="function")c=arguments[e];this.create_form('param',{container:b,beforeShow:function(){if(a.task.on_param_form_created)a.task.on_param_form_created.call(a,a);if(a.owner.on_param_form_created)a.owner.on_param_form_created.call(a,a);if(a.on_param_form_created)a.on_param_form_created.call(a,a);},onShown:function(){if(a.task.on_param_form_shown)a.task.on_param_form_shown.call(a,a);if(a.owner.on_param_form_shown)a.owner.on_param_form_shown.call(a,a);if(a.on_param_form_shown)a.on_param_form_shown.call(a,a);},onHide:function(b){var c,d;if(a.on_param_form_close_query)d=a.on_param_form_close_query.call(a,a);if(d===undefined&&a.owner.on_param_form_close_query)d=a.owner.on_param_form_close_query.call(a,a);if(d===undefined&&a.task.on_param_form_close_query)d=a.task.on_param_form_close_query.call(a,a);return d;},onHidden:function(){if(a.task.on_param_form_closed)a.task.on_param_form_closed.call(a,a);if(!this.master&&a.owner.on_param_form_closed)a.owner.on_param_form_closed.call(a,a);if(a.on_param_form_closed)a.on_param_form_closed.call(a,a);}});},close_param_form:function(){this.close_form('param_form');},print:function(a,b){var c=this;this.load_modules([this,this.owner],function(){c._print(a,b);});},_print:function(){var a=0,b=arguments.length,c=true,d;for(;a<b;a++)switch(typeof arguments[a]){case "function":d=arguments[a];break;case "boolean":c=arguments[a];break;}if(!c)this.eachParam(function(a){if(a.edit_visible){c=true;return false;}});if(c)this.create_param_form();else this.process_report(d);},checkParams:function(){var a,b=this.params.length;for(a=0;a<b;a++)try{this.params[a].check_valid();}catch(c){this.warning(c);return false;}return true;},process_report:function(a){var b=this,c=location.protocol+'//'+location.hostname+(location.port?':'+location.port:''),d,e,f=[];if(this.checkParams()){if(this.task.on_before_print_report)this.task.on_before_print_report.call(this,this);if(this.owner.on_before_print_report)this.owner.on_before_print_report.call(this,this);if(this.on_before_print_report)this.on_before_print_report.call(this,this);e=this.params.length;for(d=0;d<e;d++)f.push(this.params[d].get_raw_value());this.send_request('print_report',[f,c,this.extension],function(c){var d,e,f,g,h;if(c)d=c[0],e=c[1];if(e)b.warning(e);if(d)if(b.on_open_report)b.on_open_report.call(b,b,d);else if(b.owner.on_open_report)b.owner.on_open_report.call(b.owner,b,d);else{f=d.split('.').pop();if(f==='ods')window.open(d,"_self");else{h=window.open(d,"_blank");if(b.send_to_printer)h.onload=function(){h.print();g=setTimeout(function(){h.onfocus=function(){h.close();};},1000);};}}if(a)a.call(b,b,d);});return true;}},create_param_inputs:function(b,c){var d,e,f,g,h=[],i=[],j,k;d={params:[],col_count:1,label_on_top:false,autocomplete:false,tabindex:undefined},c=a.extend({},d,c);if(c.params.length){f=c.params.length;for(e=0;e<f;e++)h.push(this.param_by_name(c.params[e]));}else{this.eachParam(function(a){if(a.edit_visible&&a.edit_index!==-1)h.push(a);});h.sort(function(a,b){if(a.edit_index>b.edit_index===0)return 0;if(a.edit_index>b.edit_index)return 1;else return -1;});}b.empty();j=a('<form autocomplete="off"></form>').appendTo(a("<div></div>").addClass("row-fluid").appendTo(b));if(c.autocomplete)j.attr("autocomplete","on");if(!c.label_on_top)j.addClass("form-horizontal");f=h.length;for(g=0;g<c.col_count;g++)i.push(a("<div></div>").addClass("span"+12/c.col_count).appendTo(j));k=c.tabindex;if(!k&&this.param_form){k=this.param_form.tabindex;this.param_form.tabindex+=f;}for(e=0;e<f;e++)new u(h[e],e+k,i[Math.floor(e%c.col_count)],c.label_on_top);}});m.prototype=new k();m.prototype.constructor=m;function m(a,b,c,d,e,f,g){k.call(this,a,b,c,d,e,f,g);this.master=a;a.details.push(this);a.details[c]=this;this.item_type="detail";}m.prototype.getChildClass=function(){return undefined;};function n(a,b){this.owner=a;this.set_info(b);this.controls=[];this.bind_index=null;this.lookup_index=null;this.field_type=this.type_names[this.data_type];this.field_kind=d.ITEM_FIELD;if(a)a._fields.push(this);Object.defineProperty(this,"value",{get:function(){return this.get_value();},set:function(a){this.set_value(a);}});Object.defineProperty(this,"raw_value",{get:function(){return this.get_raw_value();}});Object.defineProperty(this,"text",{get:function(){return this.get_text();},set:function(a){this.set_text(a);}});Object.defineProperty(this,"display_text",{get:function(){return this.get_display_text();}});Object.defineProperty(this,"lookup_text",{get:function(){return this.get_lookup_text();}});Object.defineProperty(this,"lookup_value",{get:function(){return this.get_lookup_value();},set:function(a){this.set_lookup_value(a);}});Object.defineProperty(this,"alignment",{get:function(){return this.get_alignment();},set:function(a){this.set_alignment(a);}});Object.defineProperty(this,"read_only",{get:function(){return this._get_read_only();},set:function(a){this._set_read_only(a);}});}n.prototype={constructor:n,attr:["ID","field_name","field_caption","data_type","required","lookup_item","master_field","lookup_field","view_visible","view_index","edit_visible","edit_index","_read_only","_expand","_word_wrap","field_size","default_value","is_default","calculated","editable","_alignment","lookup_values","enable_typeahead","field_help","field_placeholder"],type_names:["","text","integer","float",'currency',"date","datetime","boolean","blob"],copy:function(a){var b=new n(a,this.get_info());b.lookup_item=this.lookup_item;b.lookup_field=this.lookup_field;return b;},get_info:function(){var a,b=this.attr.length,c=[];for(a=0;a<b;a++)c.push(this[this.attr[a]]);return c;},set_info:function(a){if(a){var b,c=this.attr.length;for(b=0;b<c;b++)this[this.attr[b]]=a[b];}},get_row:function(){if(this.owner._dataset)return this.owner._dataset[this.owner._get_rec_no()];else throw 'An attempt to get a field value in the empty dataset - item: '+this.owner.item_name;},get_data:function(){var a;if(this.field_kind===d.ITEM_FIELD){a=this.get_row();if(a&&this.bind_index>=0)return a[this.bind_index];}else return this._value;},set_data:function(a){var b;if(this.field_kind===d.ITEM_FIELD){b=this.get_row();if(b&&this.bind_index>=0)b[this.bind_index]=a;}else this._value=a;},get_lookup_data:function(){var a;if(this.field_kind===d.ITEM_FIELD){a=this.get_row();if(a&&this.lookup_index>=0)return a[this.lookup_index];}else return this._lookup_value;},set_lookup_data:function(a){var b;if(this.field_kind===d.ITEM_FIELD){b=this.get_row();if(b&&this.lookup_index>=0)b[this.lookup_index]=a;}else this._lookup_value=a;},get_text:function(){var a="",b="";try{a=this.get_value();if(a!==null)switch(this.data_type){case d.TEXT:break;case d.INTEGER:a=this.int_to_str(a);break;case d.FLOAT:a=this.float_to_str(a);break;case d.CURRENCY:a=this.float_to_str(a);break;case d.DATE:a=this.date_to_str(a);break;case d.DATETIME:a=this.datetime_to_str(a);break;case d.BOOLEAN:if(this.get_value())a=c.yes;else a=c.no;break;}else a="";}catch(e){a='';this.do_on_error(e);}if(typeof a!=='string')a='';return a;},set_text:function(a){var b="";if(a!==this.get_text())try{switch(this.data_type){case d.TEXT:this.set_value(a);break;case d.INTEGER:this.set_value(this.str_to_int(a));break;case d.FLOAT:this.set_value(this.str_to_float(a));break;case d.CURRENCY:this.set_value(this.str_to_float(a));break;case d.DATE:this.set_value(this.str_to_date(a));break;case d.DATETIME:this.set_value(this.str_to_datetime(a));break;case d.BOOLEAN:if(c)if(a.length&&a.toUpperCase().trim()===c.yes.toUpperCase().trim())this.set_value(true);else this.set_value(false);else if(a.length&&(a[0]==='T'||a[0]==='t'))this.set_value(true);else this.set_value(false);break;default:this.set_value(a);}}catch(e){b=this.field_caption+": "+this.type_error();this.do_on_error(b);}},convert_date_time:function(a){if(a.search('.')!==-1)a=a.split('.')[0];return this.format_string_to_date(a,'%Y-%m-%d %H:%M:%S');},convert_date:function(a){if(a.search(' ')!==-1)a=a.split(' ')[0];return this.format_string_to_date(a,'%Y-%m-%d');},get_raw_value:function(){var a=this.get_data();if(this.data_type===d.DATETIME&&a)a=a.replace('T',' ');return a;},get_value:function(){var a=this.get_raw_value();if(a===null){if(this.field_kind===d.ITEM_FIELD)switch(this.data_type){case d.INTEGER:a=0;break;case d.FLOAT:a=0;break;case d.CURRENCY:a=0;break;case d.TEXT:a='';break;case d.BOOLEAN:a=false;break;}}else switch(this.data_type){case d.DATE:a=this.convert_date(a);break;case d.DATETIME:a=this.convert_date_time(a);break;case d.BOOLEAN:return a?true:false;break;}return a;},_change_lookup_field:function(a,b){var c=this,d=this.owner,e;if(this.lookup_item){if(this.owner){e=this;if(this.master_field)e=this.master_field;e.lookup_value=null;this.owner.each_field(function(a){if(a.master_field===e)if(e===c&&b&&b[a.field_name])a.lookup_value=b[a.field_name];else a.lookup_value=null;});}if(a)this.lookup_value=a;}},_do_before_changed:function(){if(this.field_kind===d.ITEM_FIELD){if(this.owner._get_item_state()!==d.STATE_INSERT&&this.owner._get_item_state()!==d.STATE_EDIT)throw this.owner.item_name+' is not in edit or insert mode';if(this.owner.on_before_field_changed)this.owner.on_before_field_changed.call(this.owner,this);}},_do_after_changed:function(a){if(this.owner&&this.owner.on_field_changed)this.owner.on_field_changed.call(this.owner,this,a);if(this.filter){this.filter.update(this);if(this.filter.owner.on_filter_changed)this.filter.owner.on_filter_changed.call(this.filter.owner,this.filter);}},_check_system_field_value:function(a){if(this.field_kind===d.ITEM_FIELD){if(this.field_name===this.owner._primary_key&&this.value&&this.value!==a)this.do_on_error(this.owner.item_name+': сhanging of the primary field is forbidden');if(this.field_name===this.owner._deleted_flag&&this.value!==a)this.do_on_error(this.owner.item_name+': сhanging of the primary field is forbidden');}},_is_filter_value:function(b){if(this.field_kind===d.FILTER_FIELD)if(a.inArray(this.filter.filter_type,[d.FILTER_IN,d.FILTER_NOT_IN])!==-1){if(!a.isArray(b))this.do_on_error('Filter "'+this.filter.filter_name+'" value must be an array');return true;}},set_value:function(a,b,c,e){var f;if(a===undefined)a=null;this._check_system_field_value(a);this.new_value=null;this.new_lookup_value=b;if(a!==null){this.new_value=a;if(!this._is_filter_value(a))switch(this.data_type){case d.INTEGER:this.new_value=a;if(typeof a==="string")this.new_value=parseInt(a,10);break;case d.FLOAT:this.new_value=a;if(typeof a==="string")this.new_value=parseFloat(a);break;case d.CURRENCY:this.new_value=a;if(typeof a==="string")this.new_value=parseFloat(a);break;case d.BOOLEAN:this.new_value=a?1:0;break;case d.DATE:this.new_value=this.format_date_to_string(a,'%Y-%m-%d');break;case d.DATETIME:this.new_value=this.format_date_to_string(a,'%Y-%m-%d %H:%M:%S');break;case d.TEXT:this.new_value=a+'';break;}}if(this.get_raw_value()!==this.new_value){this._do_before_changed();try{this.set_data(this.new_value);}catch(g){f=this.field_name+": "+this.type_error();this.do_on_error(f);}this._change_lookup_field(b,c);this._set_modified(true);this._do_after_changed(e);}else if(b&&b!==this.lookup_value){this.lookup_value=b;this._do_after_changed(e,c);}this.new_value=null;this.new_lookup_value=null;this.update_controls();},_set_modified:function(a){if(this.field_kind===d.ITEM_FIELD)if(this.owner._set_modified&&!this.calculated)this.owner._set_modified(a);},get_lookup_data_type:function(){if(this.lookup_values)return d.TEXT;else if(this.lookup_item)return this.lookup_item._field_by_name(this.lookup_field).data_type;else return this.data_type;},get_lookup_value:function(){var a=null;if(this.lookup_item&&this.get_value()){a=this.get_lookup_data();switch(this.get_lookup_data_type()){case d.DATE:if(typeof a==="string")a=this.convert_date(a);break;case d.DATETIME:if(typeof a==="string")a=this.convert_date_time(a);break;case d.BOOLEAN:if(a)return true;else return false;break;}}else a=this.get_value();return a;},set_lookup_value:function(a){if(this.lookup_item){this.set_lookup_data(a);this.update_controls();}},get_lookup_text:function(){var a=this,b,c='';try{if(this.lookup_item){if(this.get_value())c=this.get_lookup_value();if(c===null)c='';else{b=this.get_lookup_data_type();if(b)switch(b){case d.DATE:c=this.date_to_str(c);break;case d.DATETIME:c=this.datetime_to_str(c);break;case d.FLOAT:c=this.float_to_str(c);break;case d.CURRENCY:c=this.cur_to_str(c);break;}}}}catch(e){}return c;},_get_value_in_list:function(){var a=0,b=this.lookup_values.length,c='';for(;a<b;a++)if(this.lookup_values[a][0]===this.value)c=this.lookup_values[a][1];return c;},get_display_text:function(){var a,b='';if(this.lookup_values)try{b=this._get_value_in_list();}catch(c){}else if(this.lookup_item)b=this.get_lookup_text();else if(this.data_type===d.CURRENCY){if(this.raw_value!==null)b=this.cur_to_str(this.get_value());}else b=this.get_text();if(this.owner&&(this.owner.on_field_get_text||this.owner.on_get_field_text))if(!this.on_field_get_text_called){this.on_field_get_text_called=true;try{if(this.owner.on_field_get_text)a=this.owner.on_field_get_text.call(this.owner,this);else if(this.owner.on_get_field_text)a=this.owner.on_get_field_text.call(this.owner,this);if(a!==undefined)b=a;}finally{this.on_field_get_text_called=false;}}if(b===undefined)b='';return b;},_set_read_only:function(a){this._read_only=a;this.update_controls();},_get_read_only:function(){var a=this._read_only;if(this.owner&&this.owner._parent_read_only&&this.owner._get_read_only())a=this.owner._get_read_only();return a;},set_visible:function(a){this._visible=a;this.update_controls();},get_visible:function(){return this._visible;},set_alignment:function(a){this._alignment=a;this.update_controls();},get_alignment:function(){return this._alignment;},set_expand:function(a){this._expand=a;this.update_controls();},get_expand:function(){return this._expand;},set_word_wrap:function(a){this._word_wrap=a;this.update_controls();},get_word_wrap:function(){return this._word_wrap;},check_type:function(){this.get_value();if((this.data_type===d.TEXT)&&(this.field_size!==0)&&(this.get_text().length>this.field_size))this.do_on_error(this.field_caption+': '+c.invalid_length.replace('%s',this.field_size));return true;},check_reqired:function(){if(!this.required)return true;else if(this.get_raw_value()!==null)return true;else this.do_on_error(this.field_caption+': '+c.value_required);},check_valid:function(){var a;if(this.check_reqired())if(this.check_type()){if(this.owner&&this.owner.on_field_validate){a=this.owner.on_field_validate.call(this.owner,this);if(a){this.do_on_error(a);return;}}if(this.filter){a=this.filter.check_value(this);if(a){this.do_on_error(a);return;}}return true;}},typeahead_options:function(){var a=this,b=10,c=a.lookup_item.copy(),d;c.lookup_field=this,d={length:b,lookup_item:c,source:function(d,e){var f={};if(a.owner&&a.owner.on_param_select_value)a.owner.on_param_select_value.call(a.owner,a,c);if(a.owner&&a.owner.on_field_select_value)a.owner.on_field_select_value.call(a.owner,a,c);if(a.filter&&a.filter.owner.on_filter_select_value)a.filter.owner.on_filter_select_value.call(a.filter.owner,a.filter,c);f.__search=[a.lookup_field,d];c.open({limit:b,params:f},function(b){var c=[],d=b.field_by_name(a.lookup_field);b.each(function(a){c.push([a.id.value,d.value]);});return e(c);});}};return d;},get_typeahead_defs:function(a){var b=this,c,d=10,e;c=b.lookup_item.copy(),c.lookup_field=this,e={items:d,lookup_item:c,field:this,source:function(a,e){var f={};if(b.owner&&b.owner.on_param_select_value)b.owner.on_param_select_value.call(b.owner,b,c);if(b.owner&&b.owner.on_field_select_value)b.owner.on_field_select_value.call(b.owner,b,c);if(b.filter&&b.filter.owner.on_filter_select_value)b.filter.owner.on_filter_select_value.call(b.filter.owner,b.filter,c);f.__search=[b.lookup_field,a];c.open({limit:d,params:f},function(a){var c=[],d=a.field_by_name(b.lookup_field);a.each(function(a){console.log(a.id.value,d.value);c.push([a.id.value,d.value]);});return e(c);});}};return e;},do_on_error:function(a){throw a;},system_field:function(){if(this.field_name===this.owner._primary_key||this.field_name===this.owner._deleted_flag||this.field_name===this.owner._master_id||this.field_name===this.owner._master_rec_id)return true;},update_controls:function(a){var b,c;c=this.controls.length;for(b=0;b<c;b++)this.controls[b].update();if(!a&&this.owner&&this.owner.controls){c=this.owner.controls.length;for(b=0;b<c;b++)this.owner.controls[b].update_field(this);}},update_control_state:function(a){for(var b=0;b<this.controls.length;b++){this.controls[b].error=a;this.controls[b].updateState(false);}},type_error:function(){switch(this.data_type){case d.INTEGER:return c.invalid_int.replace('%s','');case d.FLOAT:return c.invalid_float.replace('%s','');case d.CURRENCY:return c.invalid_cur.replace('%s','');case d.DATE:return c.invalid_date.replace('%s','');case d.DATE_TIME:return c.invalid_date.replace('%s','');case d.BOOLEAN:return c.invalid_bool.replace('%s','');default:return c.invalid_value.replace('%s','');}},valid_char_code:function(a){var c=String.fromCharCode(a),e=a>=48&&a<=57,f=c==='.'||c===b.DECIMAL_POINT||c===b.MON_DECIMAL_POINT,g=c==='+'||c==='-',h=this.get_lookup_data_type();if(h===d.INTEGER)if(!e&&!g)return false;if(h===d.FLOAT||h===d.CURRENCY)if(!e&&!g&&!f)return false;return true;},str_to_int:function(a){var b=parseInt(a,10);if(isNaN(b))throw "invalid integer value";return b;},str_to_date:function(a){return this.format_string_to_date(a,b.D_FMT);},str_to_datetime:function(a){return this.format_string_to_date(a,b.D_T_FMT);},str_to_float:function(a){var c;a=a.replace(b.DECIMAL_POINT,".");a=a.replace(b.MON_DECIMAL_POINT,".");c=parseFloat(a);if(isNaN(c))throw "invalid float value";return c;},str_to_cur:function(c){var d='';if(value){d=a.trim(c);if(b.MON_THOUSANDS_SEP)d=d.replace(b.MON_THOUSANDS_SEP,'');if(b.CURRENCY_SYMBOL)d=a.trim(d.replace(b.CURRENCY_SYMBOL,''));if(b.POSITIVE_SIGN)d=d.replace(b.POSITIVE_SIGN,'');if(b.NEGATIVE_SIGN&&d.indexOf(b.NEGATIVE_SIGN)!==-1){d=d.replace(b.NEGATIVE_SIGN,'');d='-'+d;}d=a.trim(d.replace(b.MON_DECIMAL_POINT,'.'));d=parseFloat(d);}return d;},int_to_str:function(a){if(a||a===0)return a.toString();else return '';},float_to_str:function(a){var c,d,e='';if(a||a===0){c=(''+a.toFixed(6)).replace(".",b.DECIMAL_POINT);d=c.length-1;for(;d>=0;d--)if((c[d]==='0')&&(e.length===0))continue;else e=c[d]+e;if(e.slice(e.length-1)===b.DECIMAL_POINT)e=e+'0';}return e;},date_to_str:function(a){if(a)return this.format_date_to_string(a,b.D_FMT);else return '';},datetime_to_str:function(a){if(a)return this.format_date_to_string(a,b.D_T_FMT);else return '';},cur_to_str:function(a){var c,d,e,f,g,h=0,i,j='';if(a||a===0){j=a.toFixed(b.FRAC_DIGITS);if(isNaN(j[0]))j=j.slice(1,j.length);c=j.indexOf('.');d='';e=j;if(c>=0){e=j.slice(0,c);d=j.slice(c+1,j.length);}j='';i=e.length;for(f=0;f<i;f++){g=e[i-f-1];j=g+j;h+=1;if((h%3===0)&&(f!==i-1))j=b.MON_THOUSANDS_SEP+j;}if(d)j=j+b.MON_DECIMAL_POINT+d;if(a<0){if(b.N_SIGN_POSN===3)j=b.NEGATIVE_SIGN+j;else if(b.N_SIGN_POSN===4)j=b.result+b.NEGATIVE_SIGN;}else if(b.P_SIGN_POSN===3)j=b.POSITIVE_SIGN+j;else if(b.P_SIGN_POSN===4)j=j+b.POSITIVE_SIGN;if(b.CURRENCY_SYMBOL)if(a<0)if(b.N_CS_PRECEDES)if(b.N_SEP_BY_SPACE)j=b.CURRENCY_SYMBOL+' '+j;else j=b.CURRENCY_SYMBOL+j;else if(b.N_SEP_BY_SPACE)j=j+' '+b.CURRENCY_SYMBOL;else j=j+b.CURRENCY_SYMBOL;else if(b.P_CS_PRECEDES)if(b.P_SEP_BY_SPACE)j=b.CURRENCY_SYMBOL+' '+j;else j=b.CURRENCY_SYMBOL+j;else if(b.P_SEP_BY_SPACE)j=j+' '+b.CURRENCY_SYMBOL;else j=j+b.CURRENCY_SYMBOL;if(a<0){if(b.N_SIGN_POSN===0&&b.NEGATIVE_SIGN)j=b.NEGATIVE_SIGN+'('+j+')';else if(b.N_SIGN_POSN===1)j=b.NEGATIVE_SIGN+j;else if(b.N_SIGN_POSN===2)j=j+b.NEGATIVE_SIGN;}else if(b.P_SIGN_POSN===0&&b.POSITIVE_SIGN)j=b.POSITIVE_SIGN+'('+j+')';else if(b.P_SIGN_POSN===1)j=b.POSITIVE_SIGN+j;else if(b.P_SIGN_POSN===2)j=j+b.POSITIVE_SIGN;}return j;},parseDateInt:function(a,b){var c=parseInt(a.substring(0,b),10);if(isNaN(c))throw 'invalid date';return c;},format_string_to_date:function(a,b){var c='',d=a,e,f,g,h=0,i=0,j=0;for(var k=0;k<b.length;++k){c=b.charAt(k);switch(c){case "%":break;case "d":e=this.parseDateInt(d,2);d=d.slice(2);break;case "m":f=this.parseDateInt(d,2);d=d.slice(2);break;case "Y":g=this.parseDateInt(d,4);d=d.slice(4);break;case "H":h=this.parseDateInt(d,2);d=d.slice(2);break;case "M":i=this.parseDateInt(d,2);d=d.slice(2);break;case "S":j=this.parseDateInt(d,2);d=d.slice(2);break;default:d=d.slice(c.length);}}return new Date(g,f-1,e,h,i,j);},leftPad:function(a,b,c){var d=a.toString();while(d.length<b)d=c+d;return d;},format_date_to_string:function(a,b){var c='',d='';for(var e=0;e<b.length;++e){c=b.charAt(e);switch(c){case "%":break;case "d":d+=this.leftPad(a.getDate(),2,'0');break;case "m":d+=this.leftPad(a.getMonth()+1,2,'0');break;case "Y":d+=a.getFullYear();break;case "H":d+=this.leftPad(a.getHours(),2,'0');break;case "M":d+=this.leftPad(a.getMinutes(),2,'0');break;case "S":d+=this.leftPad(a.getSeconds(),2,'0');break;default:d+=c;}}return d;},select_value:function(){var a=this.lookup_item.copy();a.is_lookup_item=true;a.lookup_field=this;if(this.owner&&this.owner.on_param_select_value)this.owner.on_param_select_value.call(this.owner,this,a);if(this.owner&&this.owner.on_field_select_value)this.owner.on_field_select_value.call(this.owner,this,a);if(this.filter&&this.filter.owner.on_filter_select_value)this.filter.owner.on_filter_select_value.call(this.filter.owner,this.filter,a);a.view();}};function o(a,b){var c=this,e;this.owner=a;this.set_info(b);if(a){a.filters.push(this);if(!(this.filter_name in a.filters))a.filters[this.filter_name]=this;if(this.field_name){e=this.owner._field_by_ID(this.field_name);this.field=this.create_field(e);this.field.field_help=this.filter_help;this.field.field_placeholder=this.filter_placeholder;if(this.filter_type===d.FILTER_RANGE){this.field1=this.create_field(e);this.field1.field_help=undefined;}}}Object.defineProperty(this,"value",{get:function(){return this.get_value();},set:function(a){this.set_value(a);}});Object.defineProperty(this,"text",{get:function(){return this.get_text();}});}o.prototype={constructor:o,attr:["filter_name","filter_caption","field_name","filter_type","data_type","visible","filter_help","filter_placeholder"],create_field:function(a){var b=new n();b.set_info(a.get_info());b._read_only=false;b.filter=this;b._value=null;b._lookup_value=null;b.field_kind=d.FILTER_FIELD;return b;},copy:function(a){var b=new o(a,this.get_info());return b;},get_info:function(){var a,b=this.attr.length,c=[];for(a=0;a<b;a++)c.push(this[this.attr[a]]);return c;},set_info:function(a){if(a){var b,c=this.attr.length;for(b=0;b<c;b++)this[this.attr[b]]=a[b];}},get_value:function(){if(this.filter_type===d.FILTER_RANGE)if(this.field.raw_value!==null&&this.field1.raw_value!==null)return [this.field.raw_value,this.field1.raw_value];else return null;else return this.field.raw_value;},set_value:function(a,b){if(this.filter_type===d.FILTER_RANGE)if(a===null){this.field.value=null;this.field1.value=null;}else{this.field.value=a[0];this.field1.value=a[1];}else this.field.set_value(a,b);},update:function(a){var b=this.field;if(this.filter_type===d.FILTER_RANGE)if(a.value!==null){if(a===this.field)b=this.field1;if(b.raw_value===null)b.value=a.value;}},check_valid:function(){var a=this.check_value(this.field);if(a)throw a;},check_value:function(a){if(this.filter_type===d.FILTER_RANGE)if(this.field.raw_value===null&&this.field1.raw_value!==null||this.field.raw_value!==null&&this.field1.raw_value===null||this.field.value>this.field1.value)return c.invalid_range;},get_text:function(){var a='';if(this.visible&&this.value!=null){a=this.filter_caption+': ';if(this.filter_type===d.FILTER_RANGE)a+=this.field.get_display_text()+' - '+this.field1.get_display_text();else if(this.field.data_type===d.BOOLEAN)if(this.field.value)a+='x';else a+='-';else a+=this.field.get_display_text();}return a;}};p.prototype=new n();p.prototype.constructor=n;function p(a,b){n.call(this,a,b);this.param_name=this.field_name;this.param_caption=this.field_caption;this.field_size=0;this.report=a;this._value=null;this._lookup_value=null;this.field_kind=d.PARAM_FIELD;if(this.owner[this.param_name]===undefined)this.owner[this.param_name]=this;}function q(a,b,c,d,e,f){this.init(a,b,c,d,e,f);}q.prototype={constructor:q,init:function(b,c,d){var e=this,f={id_field:undefined,parent_field:undefined,text_field:undefined,parent_of_root_value:undefined,text_tree:undefined,on_click:undefined,on_dbl_click:undefined};this.id=b.task.controlId++;this.item=b;this.$container=c;this.options=a.extend({},f,d);this.$element=a('<div class="dbtree '+this.item.item_name+'" tabindex="0" style="overflow-x:auto; overflow-y:auto;"></div>');this.$element.css('position','relative');this.$element.data('tree',this);this.$element.tabindex=0;this.item.controls.push(this);this.$element.bind('destroyed',function(){e.item.controls.splice(e.item.controls.indexOf(e),1);});this.$element.appendTo(this.$container);this.height(c.height());this.$element.on('focus blur',function(a){e.select_node(e.selected_node,false);});this.$element.on('keyup',function(a){e.keyup(a);});this.$element.on('keydown',function(a){e.keydown(a);});if(b._get_active()&&this.$container.width())this.build();},form_closing:function(){var a=this.$element.closest('.modal');if(a)return a.data('_closing');return false;},height:function(a){if(a)this.$element.height(a);else return this.$element.height();},is_focused:function(){return this.$element.get(0)===document.activeElement;},scroll_into_view:function(){this.select_node(this.selected_node);},update:function(a){var b,c=this,e;if(this.form_closing())return;switch(a){case d.UPDATE_OPEN:this.build();break;case d.UPDATE_CANCEL:this.changed();break;case d.UPDATE_APPEND:this.changed();break;case d.UPDATE_INSERT:this.changed();break;case d.UPDATE_DELETE:this.changed();break;case d.UPDATE_SCROLLED:this.syncronize();break;case d.UPDATE_CONTROLS:this.build();break;case d.UPDATE_CLOSE:this.$element.empty();break;case d.UPDATE_REFRESH:break;}},keydown:function(a){var b=this,c,d=(a.keyCode?a.keyCode:a.which);if(this.selected_node&&!a.ctrlKey&&!a.shiftKey)switch(d){case 13:a.preventDefault();this.toggle_expanded(this.selected_node);break;case 38:a.preventDefault();c=this.selected_node.prev();if(c.length)this.select_node(c);else{c=this.selected_node.parent().parent();if(c.length&&c.prop("tagName")==="LI")this.select_node(c);}break;case 40:a.preventDefault();if(this.selected_node.hasClass('parent')&&!this.selected_node.hasClass('collapsed')){c=this.selected_node.find('ul:first li:first');if(c.length)this.select_node(c);}else{c=this.selected_node.next();if(c.length)this.select_node(c);else{c=this.selected_node.find('ul:first li:first');if(c.length)this.select_node(c);}}break;}},keyup:function(a){var b=this,c=(a.keyCode?a.keyCode:a.which);if(!a.ctrlKey&&!a.shiftKey)switch(c){case 13:break;case 38:break;case 40:break;}},build_child_nodes:function(a,b){var c=0,d=b.length,e,f,g,h,i,j,k,l,m,n,o,p;for(c=0;c<d;c++){e=b[c];f=e.id;g=e.text;h=e.rec;i='<span class="empty-bullet"></span>',j="",k="",o=this.child_nodes[f+''];if(o&&o.length){i='<i class="icon-chevron-right bullet"></i>';j=' parent';k='collapsed';}l='<li class="'+k+j+'" style="list-style: none" data-rec="'+h+'">'+'<div><span class="tree-bullet">'+i+'</span>'+'<span class="tree-text">'+g+'<span></div>';a+=l;if(o&&o.length){a+='<ul style="display: none">';a=this.build_child_nodes(a,o);a+='</ul>';}a+='</li>';a+='</li>';}return a;},collect_nodes:function(a){var b=a[this.options.id_field],c=a[this.options.parent_field],d=a[this.options.text_field],e;this.child_nodes={};a.first();while(!a.eof()){e=this.child_nodes[c.value+''];if(e===undefined){e=[];this.child_nodes[c.value+'']=e;}e.push({'id':b.value,'text':d.display_text,'rec':a.rec_no});a.next();}},build:function(){var b=this,c=this.item.clone(),d='<ul>',e,f,g,h,i,j,k;this.collect_nodes(c);this.$element.empty();k=this.child_nodes[this.options.parent_of_root_value+''];if(k&&k.length)d=this.build_child_nodes(d,k);d+='</ul>';this.$element.append(a(d));j=this.$element.find('li');f=j.length;for(e=0;e<f;e++){i=j.eq(e);g=i.data('rec');c._set_rec_no(g);this.item._cur_row=g;i.data("record",c._dataset[g]);h=c.rec_controls_info();h[this.id]=i.get();if(this.options.node_callback)this.options.node_callback(i,this.item);}this.select_node(j.eq(0));this.$element.off('click','li.parent > div span.tree-bullet');this.$element.on('click','li.parent > div span.tree-bullet',function(c){var d=a(this),e=d.parent().parent(),f;b.toggle_expanded(e);c.preventDefault();c.stopPropagation();});this.$element.off('click','li > div span.tree-text');this.$element.on('click','li > div span.tree-text',function(c){var d=a(this).parent().parent();b.select_node(d);});},toggle_expanded:function(a){var b=a.find('div:first span.tree-bullet'),c;if(a.hasClass('parent')){c=a.find('ul:first'),a.toggleClass('collapsed');if(a.hasClass('collapsed'))b.html('<i class="icon-chevron-right bullet"></i>');else b.html('<i class="icon-chevron-down bullet"></i>');c.slideToggle(0);}},expand:function(a){if(a.hasClass('parent')&&a.hasClass('collapsed'))this.toggle_expanded(a);a=a.parent().parent();if(a.prop("tagName")==="LI")this.expand(a);},collapse:function(a){if(a.hasClass('parent')&&!a.hasClass('collapsed'))this.toggle_expanded(a);},select_node:function(a,b){var c=this,d,e;if(b===undefined)b=true;if(this.selected_node)this.selected_node.removeClass('selected selected-focused');if(a&&(!this.selected_node||a.get(0)!==this.selected_node.get(0))){this.selected_node=a;e=this.item._dataset.indexOf(a.data("record"));if(e!==this.item.rec_no)this.item._set_rec_no(e);d=this.selected_node.parent().parent();if(d.prop("tagName")==="LI")this.expand(d);}if(this.is_focused())this.selected_node.addClass('selected-focused');else this.selected_node.addClass('selected');if(b)this.update_selected_node(this.selected_node);},update_selected_node:function(a){var b,c,d,e,f;if(a.length){b=this.$element.scrollTop();c=b+this.$element.height();d=a.get(0).offsetTop;e=d+a.height();if(d<b)this.$element.scrollTop(d);else if(e>c)this.$element.scrollTop(e-this.$element.height());}},syncronize:function(){var b,c;if(this.item.record_count())try{b=this.item.rec_controls_info(),c=a(b[this.id]);this.select_node(c);}catch(d){console.log(d);}},changed:function(){}};function r(a,b,c){this.init(a,b,c);}r.prototype={constructor:r,init:function(b,e,f){var g=this,h={table_class:undefined,height:480,fields:[],column_width:{},title_word_wrap:false,row_line_count:1,expand_selected_row:0,auto_fit_width:true,multi_select:false,multi_select_title:'',multi_select_colum_width:undefined,multi_select_get_selected:undefined,multi_select_set_selected:undefined,multi_select_select_all:undefined,tabindex:0,striped:true,dblclick_edit:true,on_click:undefined,on_dblclick:undefined,on_pagecount_update:undefined,on_page_changed:undefined,editable:false,keypress_edit:true,editable_fields:undefined,selected_field:undefined,append_on_lastrow_keydown:false,sortable:false,sort_fields:undefined,row_callback:undefined,title_callback:undefined,show_footer:undefined,show_paginator:true,paginator_container:undefined};this.item=b;if(!this.item.paginate)h.striped=false;this.id=b.task.gridId++;this.$container=e;this.options=a.extend({},h,f);if(this.options.row_line_count<1)this.options.row_line_count=1;this.editMode=false;this._sorted_fields=[];this._multiple_sort=false;this.on_dblclick=this.options.on_dblclick;if(!this.options.multi_select&&this.item.lookup_field&&this.item.lookup_field.field_kind===d.FILTER_FIELD&&(this.item.lookup_field.filter.filter_type===d.FILTER_IN||this.item.lookup_field.filter.filter_type===d.FILTER_NOT_IN)){this.options.multi_select=true;this._filter_dict={};if(this.item.lookup_field.value&&this.item.lookup_field.value.length)for(var i=0;i<this.item.lookup_field.value.length;i++)this._filter_dict[this.item.lookup_field.value[i]]=true;this.options.multi_select_get_selected=function(a){return g._filter_dict[a._primary_key_field.value];},this.options.multi_select_set_selected=function(a,b){var d=[];if(b)g._filter_dict[a._primary_key_field.value]=true;else delete g._filter_dict[a._primary_key_field.value];for(var e in g._filter_dict)if(g._filter_dict.hasOwnProperty(e))d.push(parseInt(e,10));if(d.length)g.item.lookup_field.set_value(d,c.items_selected.replace('%s',d.length));else g.item.lookup_field.set_value(null,'');};}this.page=0;this.recordCount=0;this.cellWidths={};this.autoFieldWidth=true;this.fieldWidthUpdated=false;this.initFields();this.$element=a('<div class="dbtable '+b.item_name+'" style="overflow-x:auto;"></div>');if(this.options.table_class)this.$element.addClass(this.options.table_class);this.$element.data('dbtable',this);this.item.controls.push(this);this.$element.bind('destroyed',function(){g.item.controls.splice(g.item.controls.indexOf(g),1);});this.$container.empty();this.$element.appendTo(this.$container);this.createTable();if(b._get_active())setTimeout(function(){g.init_table();},0);},initFields:function(){var a=0,b,c,d;this.fields=[];if(this.options.fields.length)d=this.options.fields;else d=this.item.view_options.fields;if(d.length){b=d.length;for(;a<b;a++){c=this.item.field_by_name(d[a]);if(c)this.fields.push(c);}}this.options.editable=this.options.editable&&!this.item.read_only;if(this.options.editable)this.options.striped=false;this.editableFields=[];if(this.options.editable_fields){b=this.options.editable_fields.length;for(a=0;a<b;a++){c=this.item.field_by_name(this.options.editable_fields[a]);if(c&&!c.read_only)this.editableFields.push(c);}}else{b=this.fields.length;for(a=0;a<b;a++)if(!this.fields[a].read_only)this.editableFields.push(this.fields[a]);}this.initSelectedField();this.colspan=this.fields.length;if(this.options.multi_select)this.colspan+=1;},initKeyboardEvents:function(){var a=this,b;clearTimeout(b);b=setTimeout(function(){a.$table.on('keydown',function(b){a.keydown(b);});a.$table.on('keyup',function(b){a.keyup(b);});a.$table.on('keypress',function(b){a.keypress(b);});},400);},createTable:function(){var b=this,c=a(document),d,e,f,g,h=0,i;this.colspan=this.fields.length;if(this.options.multi_select)this.colspan+=1;this.$element.append(a('<table class="outer-table" style="width: 100%;">'+'   <thead>'+'       <tr><th>&nbsp</th></tr>'+'   </thead>'+'   <tfoot>'+'       <tr><th>&nbsp</th></tr>'+'   </tfoot>'+'   <tr>'+'       <td id="top-td" style="padding: 0; border: 0" colspan='+this.colspan+'>'+'           <div class="overlay-div" style="height: 100px; width: 100%; overflow-y: auto; overflow-x: hidden;">'+'               <table class="inner-table" style="width: 100%"></table>'+'           </div>'+'       </td>'+'   </tr>'+'</table>'));this.$outer_table=this.$element.find("table.outer-table");this.$scroll_div=this.$element.find('div.overlay-div');this.$table=this.$element.find("table.inner-table");this.$head=this.$element.find("table.outer-table thead tr:first");this.$foot=this.$element.find("table.outer-table tfoot tr:first");this.$scroll_div.keydown(function(a){var b=(a.keyCode?a.keyCode:a.which);if(b==32)a.preventDefault();});this.$element.find('table.outer-table').addClass("table table-condensed table-bordered").css("margin",0);this.$table.addClass("table table-condensed").css("margin",0).attr("disabled",false);if(this.options.striped)this.$table.addClass("table-striped");this.$table.on('mousedown dblclick','td',function(c){var d=this;if(this.nodeName!=='TD')d=a(this).closest('td');c.preventDefault();c.stopPropagation();b.clicked(c,d);});this.$element.on('mousewheel DOMMouseScroll','div.overlay-div, table.inner-table',function(a){if(a.originalEvent.wheelDelta>0||a.originalEvent.detail<0)b.prior_record();else b.next_record();a.preventDefault();a.stopPropagation();});this.$table.on('click','td',function(a){if(b.options.on_click)b.options.on_click.call(b.item,b.item);});if(this.options.expand_selected_row&&this.options.row_line_count!==this.options.expand_selected_row)this.$table.on('mouseleave mousedown','td div',function(){var b=a(this),c=b.data('tooltip');if(c&&c.$tip)c.$tip.remove();});this.$table.on('mouseenter mouseup','td div',function(){var b=a(this),c=b.data('tooltip');if(c&&c.$tip)c.$tip.remove();if(Math.abs(this.offsetHeight-this.scrollHeight)>1||Math.abs(this.offsetWidth-this.scrollWidth)>1)b.tooltip({'placement':'right','title':b.text()}).on('hide hidden show shown',function(a){a.stopPropagation();}).eq(0).tooltip('show');});if(this.options.multi_select){var b=this;this.$table.on('mousedown','td input.multi_select',function(c){var d=a(this),e=d.is(':checked');c.preventDefault();c.stopPropagation();b.clicked(c,d.closest('td'));if(b.options.multi_select_set_selected){b.options.multi_select_set_selected.call(b.item,b.item,!e);b.update_select_all_checkbox();}});}if(this.options.multi_select_select_all){var b=this;this.$outer_table.on('click','th input.multi_select',function(c){b.options.multi_select_select_all.call(b.item,b.item,a(this).is(':checked'));});}this.$table.attr("tabindex",this.options.tabindex);this.initKeyboardEvents();this.$element.on('mousemove.grid-title','table.outer-table thead tr:first th',function(c){var d=a(this),e=d.data('field_name'),f=b.$element.find("thead tr:first th:last").get(0);if(d.outerWidth()-c.offsetX<8&&!i&&this!==f)d.css('cursor','col-resize');else if(b.options.sortable&&(!b.options.sort_fields||b.options.sort_fields.indexOf(e)!==-1))d.css('cursor','pointer');else d.css('cursor','default');});function j(a){var c=h+a.screenX-i,f=parseInt(d.css("left"),10);if(i){a.preventDefault();if(c>-(e.innerWidth()-30)&&(!b.options.auto_fit_width||c<(g.innerWidth()-30))){h=c;d.css('left',f+a.screenX-i);}i=a.screenX;}}function k(a,c){var d,e,f,g,h;d=a.data('field_name');e=b.$table.find('td.'+d);f=b.$element.find("tfoot tr:first th."+d);g=b.getCellWidth(d);h=g+c;e.width(h);e.find('div').width(h);a.width(h);a.find('div').width(h);f.width(h);f.find('div').width(h);b.syncColWidth();h=a.width();b.setCellWidth(d,h);return h-g;}function l(a){var f,j,l,m;c.off("mousemove.grid-title");c.off("mouseup.grid-title");if(h<0){h=k(e,h);if(b.options.auto_fit_width)k(g,-h);}else if(b.options.auto_fit_width){h=-k(g,-h);k(e,h);}else k(e,h);i=undefined;d.remove();}this.$element.on('mousedown.grid-title','table.outer-table thead tr:first th',function(f){var k=a(this),m,n,o=k.data('field_name'),p,q,r=[],m,s=false,t,u,v;n=b.$element.find("thead tr:first th:last").get(0);if(k.outerWidth()-f.offsetX<8&&this!==n){k.css('cursor','default');i=f.screenX;e=k;m=b.fields.indexOf(b.item.field_by_name(o));t=b.fields[m+1].field_name;g=b.$element.find("thead tr:first th."+t);h=0;c.on("mousemove.grid-title",j);c.on("mouseup.grid-title",l);d=a('<div>').addClass('selection-box').css({'width':0,'height':b.$outer_table.find('thead').innerHeight()+b.$scroll_div.innerHeight(),'left':k.position().left+k.outerWidth(),'top':b.$element.position().top});d.appendTo(b.$element);}else if(o&&b.options.sortable&&(!b.options.sort_fields||b.options.sort_fields.indexOf(o)!==-1)){if(f.ctrlKey){if(!b._multiple_sort)b._multiple_sort=true;}else if(b._multiple_sort){b._sorted_fields=[];b._multiple_sort=false;}q=b.item.field_by_name(o).ID;v=b._sorted_fields.slice();if(b._multiple_sort){m=-1;for(var w=0;w<v.length;w++)if(v[w][0]===q){m=w;break;}if(m===-1)v.push([q,false]);else v[m][1]=!v[m][1];}else if(v.length&&v[0][0]===q)v[0][1]=!v[0][1];else v=[[q,false]];b._sorted_fields=v.slice();if(b.item.master||!b.item.paginate)b.item._sort(b._sorted_fields);else{b.item._open_params.__order=b._sorted_fields;b.item.open({params:b.item._open_params,offset:0});}}});this.$table.focus(function(a){if(!this.syncronizing){this.syncronizing=true;try{b.syncronize();}finally{this.syncronizing=false;}}});this.$table.blur(function(a){b.syncronize();});this.createPager();this.createFooter();this.calculate();},calculate:function(){var b,c,d,e,f,g,h,i,j,k;c=this.$element.clone().css("float","left").css("position","absolute").css("top",-1000),c.width(this.$container.width());this.fillTitle(c);this.createFooter(c);d=c.find("table.inner-table");if(this.options.multi_select)e='<tr><td><div><input type="checkbox"></div></td><td><div>W</div></td></tr>';else e='<tr><td><div>W</div></td></tr>';for(b=0;b<10;b++)d.append(e);a('body').append(c);f=d.find('tr:last td');this.textHeight=f.find('div').height();i=f.outerHeight(true);g=i*10-d.innerHeight();h=Math.abs(Math.abs(g)-10);if(h&&h<5&&g<0){i+=Math.round(h);g=i*10-d.innerHeight();}this.row_height=i+(this.options.row_line_count-1)*this.textHeight;this.selected_row_height=0;j=c.outerHeight();k=c.find('div.overlay-div').innerHeight();c.remove();this.$scroll_div.height(this.options.height-(j-k));if(this.item.paginate){k=this.$scroll_div.innerHeight()+g;if(this.options.expand_selected_row){this.selected_row_height=i+(this.options.expand_selected_row-1)*this.textHeight;k=this.$scroll_div.height()-this.selected_row_height+g;}this.row_count=Math.floor(k/this.row_height);if(this.options.expand_selected_row)this.row_count+=1;if(this.row_count<=0)this.row_count=1;this.item._pg_limit=this.row_count;}},createPager:function(b){var d=this,e,f,g,h;if(this.item.paginate&&this.options.show_paginator){g=-1;e=a('<td class="pager" style="line-height: 0" colspan='+this.colspan+'>'+'   <div id="pager" style="margin: 0 auto">'+'       <form class="form-inline" style="margin: 0">'+'           <a class="btn btn-small" tabindex="-1" href="first"><i class="icon-backward"></i></a>'+'           <a class="btn btn-small" tabindex="-1" href="prior"><i class="icon-chevron-left"></i></a>'+'           <label  class="control-label" for="input-page" style="margin: 0px 4px">'+c.page+'</label>'+'           <input class="pager-input input-mini" id="input-page" tabindex="'+g+'" type="text">'+'           <label id="page-count" class="control-label" for="input-page" style="margin: 0px 4px">'+c.of+'1000000 </label>'+'           <a class="btn btn-small" tabindex="-1" href="next"><i class="icon-chevron-right"></i></a>'+'           <a class="btn btn-small" tabindex="-1" href="last"><i class="icon-forward"></i></a>'+'       </form>'+'   </div>'+'</td>');this.$fistPageBtn=e.find('[href="first"]');this.$fistPageBtn.on("click",function(a){d.firstPage();a.preventDefault();});this.$fistPageBtn.addClass("disabled");this.$priorPageBtn=e.find('[href="prior"]');this.$priorPageBtn.on("click",function(a){d.priorPage();a.preventDefault();});this.$priorPageBtn.addClass("disabled");this.$nextPageBtn=e.find('[href="next"]');this.$nextPageBtn.on("click",function(a){d.nextPage();a.preventDefault();});this.$lastPageBtn=e.find('[href="last"]');this.$lastPageBtn.on("click",function(a){d.lastPage();a.preventDefault();});this.$pageInput=e.find('input');this.$pageInput.val(1);this.$pageInput.on("keydown",function(a){var b,c=(a.keyCode?a.keyCode:a.which);if(c===13){b=parseInt(d.$pageInput.val(),10);a.preventDefault();if(!isNaN(b)&&(b>0)){d.$pageInput.val(b);d.setPageNumber(b-1);}}});this.$page_count=e.find('#page-count');this.$page_count.text(c.of+'1000000');f=e.find('#pager').clone().css("float","left").css("position","absolute").css("top",-1000);a("body").append(f);h=f.width();f.remove();if(this.options.paginator_container){this.options.paginator_container.empty();this.options.paginator_container.append(e);}else if(b)b.find('tfoot').append(e);else this.$element.find('tfoot').append(e);this.$page_count.text(c.of+' ');e.find('#pager').width(h);}},initSelectedField:function(){var a;if(!this.selectedField&&this.editableFields.length){this.selectedField=this.editableFields[0];if(this.options.selected_field){a=this.item.field_by_name(this.options.selected_field);if(this.editableFields.indexOf(a)!==-1)this.selectedField=a;}}},setSelectedField:function(a){var b=this,c=this.selectedField!==a;if(this.editableFields.indexOf(a)!==-1){if(c&&this.options.editable){this.flushEditor();this.hideEditor();}this.hide_selection();this.selectedField=a;if(c&&this.options.editable&&this.editMode){clearTimeout(this.editorsTimeOut);this.editorsTimeOut=setTimeout(function(){b.showEditor();},75);}this.show_selection();}},nextField:function(){var a;if(this.selectedField){a=this.editableFields.indexOf(this.selectedField);if(a<this.editableFields.length-1)this.setSelectedField(this.editableFields[a+1]);}},priorField:function(){var a;if(this.selectedField){a=this.editableFields.indexOf(this.selectedField);if(a>0)this.setSelectedField(this.editableFields[a-1]);}},hideEditor:function(){var a,b,c,d;d;if(this.editing){try{this.editMode=false;d=this.editor.$controlGroup.parent();b=this.editor.field;c=d.find('div.'+b.field_name);a=d.outerWidth();d.css("padding-left",this.editor.paddingLeft);d.css("padding-top",this.editor.paddingTop);d.css("padding-right",this.editor.paddingRight);d.css("padding-bottom",this.editor.paddingBottom);this.editor.$controlGroup.remove();this.editor.removed=true;this.editor=undefined;d.outerWidth(a);c.show();}finally{this.editing=false;}this.focus();}},flushEditor:function(){if(this.editor&&this.editing)this.editor.change_field_text();},showEditor:function(){var b,c,d,e,f=this.itemRow();if(f&&!this.editing&&this.selectedField&&this.item.record_count()){if(!this.item.is_changing())this.item.edit();this.editMode=true;this.editor=new t(this,this.selectedField);this.editor.$controlGroup.find('.controls, .input-prepend, .input-append, input').css('margin-bottom',0);this.editor.$controlGroup.css('margin-bottom',0);d=f.find('div.'+this.editor.field.field_name);d.hide();e=f.find('td.'+this.editor.field.field_name);this.editor.$input.css('font-size',e.css('font-size'));b=e.outerWidth();this.editor.paddingLeft=e.css("padding-left");this.editor.paddingTop=e.css("padding-top");this.editor.paddingRight=e.css("padding-right");this.editor.paddingBottom=e.css("padding-bottom");this.editor.padding=e.css("padding");e.css("padding",0);e.outerWidth(b);e.append(this.editor.$controlGroup);b=0;this.editor.$input.parent().children('*').each(function(){b+=a(this).outerWidth(true);});this.editor.$input.width(this.editor.$input.width()+this.editor.$controlGroup.width()-b);this.editor.update();if(this.is_focused())this.editor.$input.focus();this.editing=true;}},height:function(a){if(a===undefined)return this.$element.height();else this.$scroll_div.height(a-(this.$element.height()-this.$scroll_div.height()));},fillTitle:function(b){var c,d,e,f,g,h,i,j,k,l={},m='',n;if(b===undefined)b=this.$element;d=this._sorted_fields.length;for(c=0;c<d;c++)try{k=this._sorted_fields[c][1];e=this.item.field_by_ID(this._sorted_fields[c][0]);if(k)l[e.field_name]='icon-arrow-down';else l[e.field_name]='icon-arrow-up';}catch(o){}f=b.find("table.outer-table thead tr:first");f.empty();if(this.options.multi_select){if(this.options.multi_select_select_all)i=a('<input class="multi_select" type="checkbox">');else if(this.options.multi_select_title)m=this.options.multi_select_title;g=a('<div class="text-center multi_select" style="overflow: hidden">'+m+'</div>');if(i)g.append(i);h=a('<th class="bottom-border multi_select"></th>').append(g);n=this.getCellWidth('multi_select');if(n&&this.fields.length){h.width(n);g.width(n);}f.append(h);}d=this.fields.length;for(c=0;c<d;c++){e=this.fields[c];g=a('<div class="text-center '+e.field_name+'" style="overflow: hidden"><p style="vertical-align: middle; margin: 0;">'+e.field_caption+'</p></div>');h=a('<th class="'+e.field_name+'" data-field_name="'+e.field_name+'" bottom-border"></th>').append(g);if(!this.options.title_word_wrap){g.css('height',this.textHeight);h.css('height',this.textHeight);}n=this.getCellWidth(e.field_name);if(n&&(c<this.fields.length-1)){h.width(n);g.width(n);}if(l[e.field_name]){h.find('p').append('<i class="'+l[e.field_name]+'"></i>');h.find('i').css('margin-left',2);}f.append(h);}if(this.options.title_callback)this.options.title_callback(f,this.item);},createFooter:function(b){var c,d,e,f,g,h,i;if(b===undefined)b=this.$element;f=b.find("table.outer-table tfoot tr:first");f.empty();if(this.options.multi_select){g=a('<div class="text-center multi_select" style="overflow: hidden"></div>');h=a('<th class="multi_select"></th>').append(g);f.append(h);}d=this.fields.length;for(c=0;c<d;c++){e=this.fields[c];g=a('<div class="text-center '+e.field_name+'" style="overflow: hidden">&nbsp</div>');h=a('<th class="'+e.field_name+'"></th>').append(g);f.append(h);}if(!this.options.show_footer)f.hide();},show_footer:function(){this.$element.find("table.outer-table tfoot tr:first").show();},hideFooter:function(){this.$element.find("table.outer-table tfoot tr:first").hide();},getCellWidth:function(a){return this.cellWidths[a];},setCellWidth:function(a,b){this.cellWidths[a]=b;},init_table:function(){if(this.item._pg_offset===0){this.initFields();this._sorted_fields=this.item._open_params.__order;if(this.item.paginate){this.page=0;this.updatePageInfo();this.updatePageCount();}else this.fieldWidthUpdated=false;}this.refresh();},form_closing:function(){var a=this.$element.closest('.modal');if(a)return a.data('_closing');return false;},update:function(a){var b,c=this,e;if(this.form_closing())return;switch(a){case d.UPDATE_OPEN:this.init_table();break;case d.UPDATE_CANCEL:this.refreshRow();break;case d.UPDATE_APPEND:e=this.addNewRow();this.$table.append(e);this.syncronize();this.syncColWidth();if(this.item.controls_enabled()&&this.item.record_count()===1)this.build();break;case d.UPDATE_INSERT:e=this.addNewRow();this.$table.prepend(e);this.syncronize();this.syncColWidth();break;case d.UPDATE_DELETE:this.deleteRow();break;case d.UPDATE_SCROLLED:this.syncronize();break;case d.UPDATE_CONTROLS:this.build();break;case d.UPDATE_CLOSE:this.$table.empty();break;case d.UPDATE_REFRESH:break;}},update_field:function(a,b){var c=this,e=this.itemRow(),f,g,h,i,j;if(this.item.active&&this.item.controls_enabled()&&this.item.record_count()){i=e.find('div.'+a.field_name);if(i.length){j=i.find('span');h=this.get_field_text(a);if(h!==j.text()){j.text(h);if(this.item.is_new()&&this.item.record_count()<10)f=true;else if(this.$table.get(0).clientWidth>this.$scroll_div.innerWidth()||this.$table.get(0).clientWidth>this.$element.innerWidth())f=true;else if(this.$table.get(0).clientWidth>this.$scroll_div.innerWidth()||this.$table.get(0).clientWidth>this.$element.innerWidth())f=true;else if(this.$table.get(0).clientWidth>this.$scroll_div.innerWidth()||this.$table.get(0).clientWidth>this.$element.innerWidth())f=true;else if((a.data_type===d.INTEGER||a.data_type===d.FLOAT||a.data_type===d.CURRENCY)&&Math.abs(i.get(0).offsetWidth-i.get(0).scrollWidth)>1)f=true;if(f||g){clearTimeout(this._update_field_timeout);this._update_field_timeout=setTimeout(function(){if(c.item.record_count()<=100)c.build();else c.syncColWidth();},0);}if(!b)this.update_selected(e);}}}},syncColWidth:function(){var a,b,c,d,e,f,g=this.fields.length;if(this.item.record_count()){a=this.$table.find("tr:first-child");if(this.options.multi_select){c=this.$head.find('th.'+'multi_select');d=a.find('td.'+'multi_select');f=c.find('div').width();c.find('div').width(f);d.find('div').width(f);f=c.width();c.width(f);d.width(f);}for(e=0;e<g-1;e++){b=this.fields[e];c=this.$head.find('th.'+b.field_name);d=a.find('td.'+b.field_name);f=c.find('div').width();c.find('div').width(f);d.find('div').width(f);f=c.width();c.width(f);d.width(f);}}},update_selected:function(a){var b,c=false;if(!a)a=this.itemRow();if(this.options.multi_select&&this.options.multi_select_get_selected){if(this.options.multi_select_get_selected.call(this.item,this.item))c=true;b=a.find('input.multi_select');if(b.length)b[0].checked=c;}if(this.options.row_callback)this.options.row_callback(a,this.item);},deleteRow:function(){var a=this.itemRow();a.remove();this.syncColWidth();},itemRow:function(){if(this.item.record_count())try{var b=this.item.rec_controls_info(),c=a(b[this.id]);this.update_selected(c);return c;}catch(d){console.log(d);}},refreshRow:function(){var a=this;this.each_field(function(b,c){a.update_field(b,true);});},do_on_edit:function(a){if(this.item.lookup_field)this.item.set_lookup_field_value();else if(!this.options.editable||(!this.editMode&&a)){if(this.on_dblclick)this.on_dblclick.call(this.item,this.item);else if(this.options.dblclick_edit)this.item.edit_record();}else if(!this.editMode&&!a&&this.options.editable)this.showEditor();},clicked:function(b,c){var d,e,f=a(c).parent();if(this.options.editable)this.setSelectedField(this.item.field_by_name(a(c).data('field_name')));d=this.item._dataset.indexOf(f.data("record"));if(this.editMode&&d!==this.item.rec_no){if(!this.item.is_edited())this.item.edit();this.flushEditor();this.item.post();}this.item._set_rec_no(d);if(!this.editing&&!this.is_focused())this.focus();if(b.type==="dblclick")this.do_on_edit(true);},hide_selection:function(){if(this.selected_row)if(this.options.editable&&this.selectedField){this.selected_row.removeClass("selected-focused selected");this.selected_row.find('td.'+this.selectedField.field_name).removeClass("field-selected-focused field-selected");}else this.selected_row.removeClass("selected-focused selected");},show_selection:function(){var a='selected',b='field-selected';if(this.is_focused()){a='selected-focused';b='field-selected-focused';}if(this.selected_row)if(this.options.editable&&this.selectedField){this.selected_row.addClass(a);this.selected_row.find('td.'+this.selectedField.field_name).removeClass(a).addClass(b);}else this.selected_row.addClass(a);},select_row:function(a){var b,c=this.textHeight,d='selected';this.update_selected_row(a);if(this.is_focused())d='selected-focused';this.hide_selection();if(this.selected_row&&this.options.expand_selected_row)this.selected_row.find('tr, div').css('height',this.options.row_line_count*c);this.selected_row=a;this.show_selection();if(this.options.expand_selected_row){b=this.selected_row.find('tr, div');b.css('height','');b.css('height',this.options.expand_selected_row*c);}},update_selected_row:function(a){var b,c,d,e;if(a.length){b=this.$scroll_div.scrollTop();c=b+this.$scroll_div.height();d=a.get(0).offsetTop;e=d+a.height();if(d<b)this.$scroll_div.scrollTop(d);else if(e>c)this.$scroll_div.scrollTop(e-this.$scroll_div.height());}},syncronize:function(){var a=this,b,c;if(this.item.controls_enabled()&&this.item.record_count()>0){c=this.itemRow();b=!this.selected_row||(this.selected_row&&c&&this.selected_row.get(0)!==c.get(0));if(b&&this.options.editable)this.hideEditor();try{this.select_row(this.itemRow());}catch(d){}if(b&&this.options.editable&&this.editMode){clearTimeout(this.editorsTimeOut);this.editorsTimeOut=setTimeout(function(){a.showEditor();},75);}}},get_field_text:function(a){return a.get_lookup_data_type()===d.BOOLEAN?a.get_lookup_value()?'×':'':a.get_display_text();},next_record:function(){this.item.next();if(this.item.eof())if(this.options.editable&&this.options.append_on_lastrow_keydown)this.item.append();else this.nextPage();},prior_record:function(){var a=this;this.item.prior();if(this.item.bof())this.priorPage(function(){a.item.last();});},keydown:function(a){var b=this,c=(a.keyCode?a.keyCode:a.which);if(!a.ctrlKey&&!a.shiftKey)switch(c){case 33:case 34:case 35:case 36:case 38:case 40:a.preventDefault();this.flushEditor();this.hideEditor();if(c===33)this.priorPage();else if(c===34)if(this.item.paginate&&this.item.is_loaded)this.item.last();else this.nextPage();else if(c===38)this.prior_record();else if(c===40)this.next_record();else if(c===36)this.firstPage();else if(c===35)this.lastPage();break;case 37:if(this.options.editable&&!this.editMode)this.priorField();break;case 39:if(this.options.editable&&!this.editMode)this.nextField();break;}},keyup:function(a){var b=this,c,d=(a.keyCode?a.keyCode:a.which);if(a.target===this.$table.get(0)&&!a.ctrlKey&&!a.shiftKey)switch(d){case 13:a.preventDefault();this.do_on_edit(false);break;case 33:case 34:case 35:case 36:case 38:case 40:a.preventDefault();break;case 32:a.preventDefault();if(this.options.multi_select_set_selected){c=this.itemRow().find('input.multi_select');if(c.length){c[0].checked=!c[0].checked;this.options.multi_select_set_selected.call(this.item,this.item,c[0].checked);}}break;}},keypress:function(a){var b=this,c,d=a.which;if(d>32&&this.options.editable&&this.options.keypress_edit&&!this.editMode)if(this.selectedField&&this.selectedField.valid_char_code(d))this.showEditor();},setPageNumber:function(a,b){var c=this;if(!this.item.paginate||this.loading)return;if(a<this.page_count||a===0){this.page=a;this.loading=true;this.item.open({offset:this.page*this.item._pg_limit},function(){if(b)b.call(c);c.loading=false;c.updatePageInfo();});}},reload:function(a){if(this.item.paginate)this.setPageNumber(this.page,a);else this.open(a);},updatePageInfo:function(){if(this.options.show_paginator){this.$pageInput.val(this.page+1);if(this.page===0){this.$fistPageBtn.addClass("disabled");this.$priorPageBtn.addClass("disabled");}else{this.$fistPageBtn.removeClass("disabled");this.$priorPageBtn.removeClass("disabled");}if(this.item.is_loaded){this.$lastPageBtn.addClass("disabled");this.$nextPageBtn.addClass("disabled");}else{this.$lastPageBtn.removeClass("disabled");this.$nextPageBtn.removeClass("disabled");}}if(this.options.on_page_changed)this.options.on_page_changed.call(this.item,this.item,this);},updatePageCount:function(a){var b=this;this.item.total_records(function(a){b.recordCount=a;b.page_count=Math.ceil(a/b.row_count);if(b.$page_count)b.$page_count.text(c.of+' '+b.page_count);if(b.options.on_pagecount_update)b.options.on_pagecount_update.call(b.item,b.item,b);if(b.options.on_page_changed)b.options.on_page_changed.call(b.item,b.item,b);});},firstPage:function(a){if(this.item.paginate)this.setPageNumber(0,a);else this.item.first();},nextPage:function(a){var b,c;if(this.item.paginate){if(!this.item.is_loaded)this.setPageNumber(this.page+1,a);}else{c=this.item.clone();c._set_rec_no(this.item._get_rec_no());b=this.$scroll_div.innerHeight()/this.row_height-1;for(var d=0;d<b;d++)if(!c.eof())c.next();else break;this.item._set_rec_no(c._get_rec_no());}},priorPage:function(a){var b,c;if(this.item.paginate)if(this.page>0)this.setPageNumber(this.page-1,a);else this.syncronize();else{c=this.item.clone();c._set_rec_no(this.item._get_rec_no());b=this.$scroll_div.innerHeight()/this.row_height-1;for(var d=0;d<b;d++)if(!c.eof())c.prior();else break;this.item._set_rec_no(c._get_rec_no());}},lastPage:function(a){var b=this;if(this.item.paginate){this.item.total_records(function(d){b.recordCount=d;b.page_count=Math.ceil(d/b.row_count);if(b.options.show_paginator)b.$page_count.text(c.of+' '+b.page_count);b.setPageNumber(b.page_count-1,a);if(b.options.on_pagecount_update)b.options.on_pagecount_update.call(this.item,this.item,this);});}else this.item.last();},each_field:function(a){var b=0,c=this.fields.length,d;for(;b<c;b++){d=a.call(this.fields[b],this.fields[b],b);if(d===false)break;}},addNewRow:function(){var b=a(this.newRow()),c=this.item._get_rec_no(),d;b.data("record",this.item._dataset[c]);d=this.item.rec_controls_info();d[this.id]=b.get();if(this.options.row_callback)this.options.row_callback(b,this.item);return b;},newColumn:function(a,b,c,d,e){var f=this.getCellWidth(a),g='class="'+a+'"',h='data-field_name="'+a+'"',i='style="text-align:'+b+';overflow: hidden'+'"',j='style="overflow: hidden';if(this.textHeight)j+='; height: '+this.options.row_line_count*this.textHeight+'px';if(e&&f&&(d<this.fields.length-1))j+='; width: '+f+'px';j+='"';return '<td '+g+' '+h+' '+i+'>'+'<div '+g+' '+j+'>'+'<span '+j+'>'+c+'</span>'+'</div>'+'</td>';},newRow:function(){var a,b,c,f,g,h,i,j='',k=!this.autoFieldWidth||(this.autoFieldWidth&&this.fieldWidthUpdated);c=this.fields.length;i='';if(this.options.multi_select){if(this.options.multi_select_get_selected)if(this.options.multi_select_get_selected.call(this.item,this.item))j='checked';i+=this.newColumn('multi_select','center','<input class="multi_select" type="checkbox" '+j+'>',-1,k);}for(b=0;b<c;b++){f=this.fields[b];a=this.item[f.field_name];if(!(a instanceof n))a=this.item.field_by_name(f.field_name);h=this.get_field_text(a);g=a.data_type===d.BOOLEAN?'center':e[a.alignment];i+=this.newColumn(a.field_name,g,h,b,k);}return '<tr class="inner">'+i+'</tr>';},getElementWidth:function(a){if(!a.length)return 0;if(a.is(':visible'))return a.width();else return this.getElementWidth(a.parent());},refresh:function(b){var c,d,e,f,g,h,i,j,k,l,m,n='',o,p,q=[],r,s,t=this.$table.is(':visible'),u,v=this.item.clone(),w=a('<div>');s=this.is_focused();if(this.options.editable&&this.editMode&&this.editor){if(!s)s=this.editor.$input.is(':focus');u=this.editor.$input.value;this.hideEditor();}w.css("position","absolute").css("top",-1000).width(this.getElementWidth(this.$element));a('body').append(w);this.$element.detach();w.append(this.$element);this.$table.empty();this.$head.empty();this.$foot.hide();this.$outer_table.find('#top-td').attr('colspan',this.colspan);v.on_field_get_text=this.item.on_field_get_text;m='';p=this.item.rec_no;try{while(!v.eof()){this.item._cur_row=v._cur_row;m+=this.newRow();q.push(v._get_rec_no());v.next();}this.$table.html(m);m=this.$table.find("tr");d=m.length;for(c=0;c<d;c++){f=m.eq(c);o=q[c];v._set_rec_no(o);this.item._cur_row=o;f.data("record",v._dataset[o]);r=v.rec_controls_info();r[this.id]=f.get();if(this.options.row_callback)this.options.row_callback(f,this.item);}}finally{this.item._cur_row=p;}f=this.$table.find("tr:first");if(this.autoFieldWidth&&!this.fieldWidthUpdated){this.$table.css('table-layout','auto');this.$outer_table.css('table-layout','auto');g='<tr>';if(this.options.multi_select){if(this.options.multi_select_title)n=this.options.multi_select_title;g=g+'<th class="multi_select">'+'<div class="text-center multi_select" style="overflow: hidden">'+n+'</div>'+'</th>';}d=this.fields.length;for(c=0;c<d;c++)g=g+'<th class="'+this.fields[c].field_name+'" ><div style="overflow: hidden">'+this.fields[c].field_caption+'</div></th>';g=a(g+'</tr>');this.$table.prepend(g);if(this.options.multi_select)if(this.options.multi_select_colum_width)g.find(".multi_select").css("width",this.options.multi_select_colum_width);else g.find(".multi_select").css("width",'3%');for(var x in this.options.column_width)if(this.options.column_width.hasOwnProperty(x))g.find("."+x).css("width",this.options.column_width[x]);if(this.options.multi_select){h=f.find("td."+'multi_select');this.setCellWidth('multi_select',h.width());}for(c=0;c<d;c++){e=this.fields[c];h=f.find("td."+e.field_name);this.setCellWidth(e.field_name,h.width());}this.$table.css('table-layout','fixed');this.$outer_table.css('table-layout','fixed');this.fillTitle(w);if(this.options.multi_select){h=f.find("td."+'multi_select');j=this.$head.find("th."+'multi_select');k=this.$foot.find("th."+'multi_select');i=this.getCellWidth('multi_select');h.find('div').width(i);h.width(i);j.find('div').width(i);j.width(i);k.find('div').width(i);k.width(i);}for(c=0;c<d;c++){e=this.fields[c];if(c<this.fields.length-1){h=f.find("td."+e.field_name);j=this.$head.find("th."+e.field_name);k=this.$foot.find("th."+e.field_name);i=this.getCellWidth(e.field_name);h.find('div').width(i);h.width(i);j.find('div').width(i);j.width(i);k.find('div').width(i);k.width(i);}}if(this.item.record_count()>0&&t)this.fieldWidthUpdated=true;g.remove();}else{this.fillTitle(w);this.syncColWidth();}if(this.options.show_footer)this.$foot.show();this.$element.detach();this.$container.append(this.$element);w.remove();this.update_select_all_checkbox();this.syncronize();if(s)this.focus();if(this.options.editable&&this.editMode&&this.editor){this.showEditor();this.editor.$input.value=u;}if(b)b.call(this);},update_select_all_checkbox:function(){var a=this;if(this.options.multi_select_select_all)setTimeout(function(){a.$outer_table.find('th input.multi_select').prop('checked',a.$table.find('td input.multi_select').is(":checked"));},200);},build:function(){var a=this.$scroll_div.scrollTop();this.initFields();this.fieldWidthUpdated=false;this.refresh();this.syncColWidth();this.$scroll_div.scrollTop(a);this.syncronize();},is_focused:function(){return this.$table.get(0)===document.activeElement;},focus:function(){if(!this.is_focused())this.$table.focus();}};function s(a){var b=this;this.field=a;this.read_only=false;}s.prototype={constructor:s,create_input:function(b,c,f){var g=this,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;if(!b)return;if(this.label)l=a('<label class="control-label"></label>').attr("for",b.field_name).text(this.label).addClass(b.field_name);if(b.get_lookup_data_type()===d.BOOLEAN)m=a('<input>').attr("id",b.field_name).attr("type","checkbox").attr("tabindex",c+"").click(function(a){g.field.value=!g.field.value;});else if(b.get_lookup_data_type()===d.BLOB)m=a('<textarea>').attr("id",b.field_name).attr("tabindex",c+"").innerHeight(70);else m=a('<input>').attr("id",b.field_name).attr("type","text").attr("tabindex",c+"");s=a('<div></div>').addClass("controls");this.$input=m;this.$input.addClass(b.field_name);this.$input.addClass('dbinput');this.$input.data('dbinput',this);this.$input.focus(function(a){g.focusIn(a);});this.$input.blur(function(a){g.focusOut();});this.$input.mousedown(function(a){g.mouseIsDown=true;});this.$input.mouseup(function(a){if(!g.mouseIsDown)g.$input.select();g.mouseIsDown=false;});this.$input.keydown(a.proxy(this.keydown,this));this.$input.keyup(a.proxy(this.keyup,this));this.$input.keypress(a.proxy(this.keypress,this));if(b.lookup_item&&!b.master_field||b.lookup_values){t=a('<div class="input-prepend input-append"></div>').addClass("input-with-buttons");r=a('<button class="btn input-button" type="button"><i class="icon-remove-sign"></button>');r.attr("tabindex",-1);r.click(function(){b.set_value(null);});this.$firstBtn=r;t.append(r);t.append(m);r=a('<button class="btn input-button" type="button"><i></button>');r.attr("tabindex",-1);r.click(function(){if(b.lookup_values)g.dropdown.enter_pressed();else g.selectValue();});this.$lastBtn=r;t.append(r);s.append(t);if(b.lookup_values){m.addClass("input-lookupvalues");this.$lastBtn.find('i').addClass("icon-chevron-down");this.dropdown=new w(this.field,m);}else{m.addClass("input-lookupitem");this.$lastBtn.find('i').addClass("icon-folder-open");if(this.field.enable_typeahead)this.dropdown=new x(this.field,m,this.field.typeahead_options());}}else{v=b.get_lookup_data_type();switch(v){case d.TEXT:m.addClass("input-text");s.append(m);break;case d.INTEGER:m.addClass("input-integer");s.append(m);break;case d.FLOAT:m.addClass("input-float");s.append(m);break;case d.CURRENCY:m.addClass("input-currency");s.append(m);break;case d.DATE:case d.DATETIME:t=a('<div class="input-prepend input-append"></div>').addClass("input-with-buttons");r=a('<button class="btn input-button" type="button"><i class="icon-remove-sign"></button>');r.attr("tabindex",-1);r.click(function(){b.set_value(null);});this.$firstBtn=r;t.append(r);m.addClass("input-date");if(v===d.DATETIME)m.addClass("input-datetime");t.append(m);r=a('<button class="btn input-button" type="button"><i class="icon-calendar"></button>');r.attr("tabindex",-1);r.click(function(){g.showDatePicker();});this.$lastBtn=r;t.append(r);s.append(t);break;case d.BOOLEAN:s.append(m);break;case d.BLOB:m.addClass("input-text");s.append(m);break;}h=b.data_type===d.BOOLEAN?'center':e[b.alignment];this.$input.css("text-align",h);}if(this.label_on_top)this.$controlGroup=a('<div class="input-container"></div>');else this.$controlGroup=a('<div class="control-group input-container"></div>');if(this.label)this.$controlGroup.append(l);this.$controlGroup.append(s);if(f)f.append(this.$controlGroup);this.$modalForm=this.$input.closest('.modal');this.field.controls.push(this);this.$input.on('mouseenter',function(){var b=a(this);if(g.error)b.tooltip('show');});if(!this.grid&&this.field.field_placeholder)this.$input.attr('placeholder',this.field.field_placeholder);if(!this.grid&&this.field.field_help){u=a('<span class="badge help-badge">?</span>');u.click(function(){var b=false,c=a('<div><b>'+g.field.field_caption+'</b>'+'<button type="button" id="close-btn" class="close" tabindex="-1" aria-hidden="true" style="padding: 0px 10px;"> ×</button></div>');c.find("#close-btn").click(function(){m.popover('destroy');b=true;});m.popover({container:'body',placement:'right',html:true,title:c,content:g.field.field_help});m.popover('show');setTimeout(function(){if(!b)m.popover('destroy');},10*1000);});if(t)t.append(u);else s.append(u);}this.$input.tooltip({placement:'bottom',title:''}).on('hide hidden show shown',function(a){a.stopPropagation();});this.$input.bind('destroyed',function(){g.field.controls.splice(g.field.controls.indexOf(g),1);if(!g.grid&&g.field.field_help)if(m.data('popover'))m.data('popover').$tip.remove();if(g.dropdown)g.dropdown.destroy();});this.update();},form_closing:function(){if(this.$modalForm)return this.$modalForm.data('_closing');return false;},update:function(){var a=this.field.field_placeholder,b=this.$input.get(0)===document.activeElement;if(this.field.field_kind===d.ITEM_FIELD)if(this.field.owner.record_count()===0){this.read_only=true;if(this.$firstBtn)this.$firstBtn.prop('disabled',this.read_only);if(this.$lastBtn)this.$lastBtn.prop('disabled',this.read_only);if(this.$input)this.$input.prop('disabled',this.read_only);return;}if(!this.removed&&!this.form_closing()){if(this.read_only!==this.field._get_read_only()){this.read_only=this.field._get_read_only();if(this.$firstBtn)this.$firstBtn.prop('disabled',this.read_only);if(this.$lastBtn)this.$lastBtn.prop('disabled',this.read_only);if(this.$input)this.$input.prop('disabled',this.read_only);}if(this.field.master_field){if(this.$firstBtn)this.$firstBtn.prop('disabled',true);if(this.$lastBtn)this.$lastBtn.prop('disabled',true);if(this.$input)this.$input.prop('disabled',true);}if(this.field.get_lookup_data_type()===d.BOOLEAN)if(this.field.get_lookup_value())this.$input.attr("checked","checked");else this.$input.removeAttr("checked","checked");if(this.field.lookup_values)this.$input.val(this.field.display_text);else if(b&&this.$input.val()!==this.field.get_text()||!b&&this.$input.val()!==this.field.get_display_text()){this.errorValue=undefined;this.error=undefined;if(b&&!this.field.lookup_item&&!this.field.lookup_values)this.$input.val(this.field.get_text());else this.$input.val(this.field.get_display_text());}if(this.read_only||this.field.master_field)a='';this.$input.attr('placeholder',a);this.updateState(true);}},keydown:function(a){var b=(a.keyCode?a.keyCode:a.which);if(this.field.lookup_item&&!this.field.enable_typeahead&&!(b===229||b===9||b==8))a.preventDefault();if(a.ctrlKey===true)if(b!==67&&b!==86&&b!==88&&b!=90&&b!=8&&b!=37&&b!=39)a.preventDefault();if(b===9)if(this.grid&&this.grid.editMode){a.preventDefault();if(a.shiftKey)this.grid.priorField();else this.grid.nextField();}},keyup:function(a){var b,c=(a.keyCode?a.keyCode:a.which);if(this.field.enable_typeahead){b=this.$input.data('jamtypeahead');if(b&&b.shown)return;}if(c===13&&!a.ctrlKey&&!a.shiftKey){if(this.grid&&this.grid.editMode){a.stopPropagation();a.preventDefault();if(!this.grid.item.is_changing())this.grid.item.edit();this.grid.flushEditor();this.grid.hideEditor();if(this.grid.item.is_changing())this.grid.item.post();}else if(this.field.lookup_item&&!this.field.enable_typeahead){a.stopPropagation();a.preventDefault();this.selectValue();}else if((this.field.data_type===d.DATE)||(this.field.data_type===d.DATETIME)){a.stopPropagation();a.preventDefault();this.showDatePicker();}}else if(c===27)if(this.grid&&this.grid.editMode){a.stopPropagation();a.preventDefault();this.grid.item.cancel();this.grid.hideEditor();}else if(this.field.lookup_values)if(this.$input.parent().hasClass('open')){this.$input.parent().removeClass('open');a.stopPropagation();}},keypress:function(a){var b=a.which;if(this.field.lookup_item&&!this.field.enable_typeahead)a.preventDefault();if(this.$input.is('select')){}else if(b&&!this.field.valid_char_code(b))a.preventDefault();},showDatePicker:function(){var a=this,e;if(this.field.data_type===d.DATE)e=b.D_FMT;else if(this.field.data_type===d.DATETIME)e=b.D_T_FMT;this.$input.datepicker({weekStart:c.week_start,format:e,daysMin:c.days_min,months:c.months,monthsShort:c.months_short,date:this.field.value}).on('show',function(b){b.stopPropagation();a.$input.datepicker().attr('data-weekStart',1);}).on('hide hidden shown',function(a){a.stopPropagation();}).on('changeDate',function(b){a.field.set_value(b.date);a.$input.datepicker('hide');});this.$input.datepicker('show');},selectValue:function(){if(this.field.on_entry_button_click)this.field.on_entry_button_click.call(this.item,this.field);else this.field.select_value();},change_field_text:function(){var a=true,b;if(this.field.owner&&this.field.owner.is_changing&&!this.field.owner.is_changing())this.field.owner.edit();this.errorValue=undefined;this.error=undefined;if(this.field.lookup_item){if(this.$input.val()!==this.field.get_lookup_text())this.$input.val(this.field.get_display_text());}else try{b=this.$input.val();if(b==='')this.field.set_value(null);else{this.field.set_text(b);this.field.check_valid();if(this.$input.is(':visible'))this.$input.val(b);}}catch(c){this.errorValue=b;this.error=c;this.updateState(false);if(this.field&&this.field.owner&&this.field.owner.task.settings.DEBUGGING)throw 'change_field_text error: '+c;a=false;}return a;},focusIn:function(a){this.hideError();if(this.field.lookup_item&&!this.field.enable_typeahead)this.$input.val(this.field.get_display_text());else{if(this.errorValue)this.$input.val(this.errorValue);else if(this.field.lookup_item||this.field.lookup_values)this.$input.val(this.field.get_display_text());else this.$input.val(this.field.get_text());if(!this.mouseIsDown){this.$input.select();this.mouseIsDown=false;}}this.mouseIsDown=false;},focusOut:function(a){var b=false;if(this.grid&&this.grid.editMode)if(this.grid.item.is_changing()){this.grid.flushEditor();this.grid.item.post();}if(this.field.data_type===d.BOOLEAN)b=true;else if(this.field.lookup_values){if(this.$input.parent().hasClass('open'))this.$input.parent().removeClass('open');b=true;}else if(this.change_field_text()){if(this.$input.is(':visible'))this.$input.val(this.field.get_display_text());b=true;}this.updateState(b);return b;},updateState:function(a){if(a){if(this.$controlGroup)this.$controlGroup.removeClass('error');this.errorValue=undefined;this.error=undefined;this.$input.tooltip('hide').attr('data-original-title','').tooltip('fixTitle');this.hideError();}else{this.showError();if(this.$controlGroup)this.$controlGroup.addClass('error');this.$input.tooltip('hide').attr('data-original-title',this.error).tooltip('fixTitle');}},showError:function(a){},hideError:function(a){},focus:function(){this.$input.focus();}};t.prototype=new s();t.prototype.constructor=t;function t(a,b){s.call(this,b);this.grid=a;this.create_input(b,0);this.$input.attr("autocomplete","off");this.$input.addClass('dbtableinput');}a.extend(t.prototype,{});u.prototype=new s();u.prototype.constructor=u;function u(a,b,c,d,e){s.call(this,a);if(this.field.owner&&this.field.owner.edit_form&&this.field.owner.edit_form.hasClass("modal"))this.$edit_form=this.field.owner.edit_form;this.label=e;this.label_on_top=d;if(!this.label)this.label=this.field.field_caption;this.create_input(a,b,c);}a.extend(u.prototype,{showError:function(a){if(this.$edit_form&&this.$edit_form.hasClass("normal-modal-border")){this.$edit_form.removeClass("nomal-modal-border");this.$edit_form.addClass("error-modal-border");}},hideError:function(a){if(this.$edit_form&&this.$edit_form.hasClass("error-modal-border")){this.$edit_form.removeClass("error-modal-border");this.$edit_form.addClass("nomal-modal-border");}}});function v(a,b,c){this.$element=b;this.field=a;this.options=c;}v.prototype={constructor:v,init:function(){var b={menu:'<ul class="typeahead dropdown-menu"></ul>',item:'<li><a href="#"></a></li>',length:10,min_length:1};this.options=a.extend({},b,this.options);this.$menu=a(this.options.menu);},show:function(){var b=a.extend({},this.$element.offset(),{height:this.$element[0].offsetHeight});this.$menu.appendTo(a('body')).css({top:b.top+b.height,left:b.left,"min-width":this.$element.innerWidth(),"max-width":a(window).width()-this.$element.offset().left-20,"overflow":"hidden"}).show();this.shown=true;return this;},hide:function(){this.$menu.hide();this.$menu.detach();this.shown=false;return this;},destroy:function(){this.$element=undefined;this.$menu.remove();},get_items:function(b){var c;if(this.$element){this.query=this.$element.val();if(!this.query||this.query.length<this.min_length)return this.shown?this.hide():this;c=a.isFunction(this.source)?this.source(this.query,a.proxy(this.process,this)):this.source;return c?this.process(c):this;}},lookup:function(a){this.get_items(a);},process:function(b){var c=this;b=a.grep(b,function(a){return c.matcher(a);});if(!b.length)return this.shown?this.hide():this;return this.render(b.slice(0,this.length)).show();},matcher:function(a){return true;},highlighter:function(a){var b=0,c,d=a,e;if(this.query){e=this.query.split(' ');for(b=0;b<e.length;b++){c=e[b];if(c.indexOf('strong>')===-1&&c.length){c=c.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,'\\$&');d=d.replace(new RegExp('('+c+')','ig'),function(a,b){return '<strong>'+b+'</strong>';});}}}return d;},render:function(b){var c=this;b=a(b).map(function(b,d){b=a(c.options.item).data('id-value',d[0]);b.find('a').html(c.highlighter(d[1]));return b[0];});b.first().addClass('active');this.$menu.html(b);return this;},next:function(b){var c=this.$menu.find('.active').removeClass('active'),d=c.next();if(!d.length)d=a(this.$menu.find('li')[0]);d.addClass('active');},prev:function(a){var b=this.$menu.find('.active').removeClass('active'),c=b.prev();if(!c.length)c=this.$menu.find('li').last();c.addClass('active');},listen:function(){this.$element.on('focus',a.proxy(this.focus,this)).on('blur',a.proxy(this.blur,this)).on('keypress',a.proxy(this.keypress,this)).on('keyup',a.proxy(this.keyup,this));if(this.eventSupported('keydown'))this.$element.on('keydown',a.proxy(this.keydown,this));this.$menu.on('click',a.proxy(this.click,this)).on('mouseenter','li',a.proxy(this.mouseenter,this)).on('mouseleave','li',a.proxy(this.mouseleave,this));},eventSupported:function(a){var b=a in this.$element;if(!b){this.$element.setAttribute(a,'return;');b=typeof this.$element[a]==='function';}return b;},move:function(a){if(!this.shown)return;switch(a.keyCode){case 9:case 13:case 27:a.preventDefault();break;case 38:a.preventDefault();this.prev();break;case 40:a.preventDefault();this.next();break;}a.stopPropagation();},keydown:function(b){this.suppressKeyPressRepeat=~a.inArray(b.keyCode,[40,38,9,13,27]);this.move(b);},keypress:function(a){if(this.suppressKeyPressRepeat)return;this.move(a);},keyup:function(a){if(!a.ctrlKey&&!a.shiftKey){switch(a.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 9:case 13:if(!this.shown){if(a.keyCode===13)this.enter_pressed();}else this.select();break;case 27:if(!this.shown)return;this.field.update_controls();if(this.$element)this.$element.select();this.hide();break;default:this.lookup();}a.stopPropagation();a.preventDefault();}},focus:function(a){this.focused=true;},blur:function(a){this.focused=false;if(!this.mousedover&&this.shown)this.hide();},click:function(a){a.stopPropagation();a.preventDefault();this.select();this.$element.focus();},mouseenter:function(b){this.mousedover=true;this.$menu.find('.active').removeClass('active');a(b.currentTarget).addClass('active');},mouseleave:function(a){this.mousedover=false;if(!this.focused&&this.shown)this.hide();}};w.prototype=new v();w.prototype.constructor=w;function w(a,b,c){v.call(this,a,b,c);this.init();this.source=this.field.lookup_values;this.options.length=this.source.length;this.listen();}a.extend(w.prototype,{matcher:function(a){if(this.query)return ~a[1].toLowerCase().indexOf(this.query.toLowerCase());else return true;},select:function(){var a=this.$menu.find('.active');this.field.value=a.data('id-value');return this.hide();},enter_pressed:function(){this.query='';this.$element.focus();this.process(this.source);}});x.prototype=new v();x.prototype.constructor=x;function x(a,b,c){v.call(this,a,b,c);this.init();this.source=this.options.source;this.lookup_item=this.options.lookup_item;this.listen();}a.extend(x.prototype,{lookup:function(a){var b=this;clearTimeout(this.timeOut);this.timeOut=setTimeout(function(){b.get_items(a);},400);},select:function(){var a=this.$menu.find('.active'),b=a.data('id-value');this.lookup_item.locate('id',b);this.lookup_item.set_lookup_field_value();return this.hide();},enter_pressed:function(){this.field.select_value();}});a.event.special.destroyed={remove:function(a){if(a.handler)a.handler();}};window.task=new h();window.task.events={};window.task.constructors={task:h,group:i,item:k,detail:m};})(jQuery);